<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>MoodFlow - ç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f7fa;
      min-height: 100vh;
      /* iOS safe area */
      padding-bottom: env(safe-area-inset-bottom);
    }

    .login-screen {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .login-card {
      background: white;
      padding: 40px;
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      max-width: 400px;
      width: 90%;
    }

    .login-card h1 {
      color: #667eea;
      margin-bottom: 30px;
      text-align: center;
    }

    .dashboard {
      display: none;
      padding: 20px;
    }

    .dashboard.active {
      display: block;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      border-radius: 15px;
      margin-bottom: 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header h1 {
      margin: 0;
      font-size: 28px;
    }

    .logout-btn {
      background: rgba(255,255,255,0.2);
      color: white;
      border: 2px solid white;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s;
    }

    .logout-btn:hover {
      background: white;
      color: #667eea;
    }

    .input-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: #555;
      margin-bottom: 8px;
    }

    input[type="text"],
    input[type="password"] {
      width: 100%;
      padding: 15px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 16px;
      transition: border-color 0.3s;
    }

    input:focus {
      outline: none;
      border-color: #667eea;
    }

    .btn {
      width: 100%;
      padding: 15px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .btn-success {
      background: #28a745;
      color: white;
    }

    .btn-danger {
      background: #dc3545;
      color: white;
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .card {
      background: white;
      padding: 25px;
      border-radius: 15px;
      margin-bottom: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .card h2 {
      color: #667eea;
      margin-bottom: 20px;
      font-size: 20px;
    }

    .controls {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }

    .controls .btn {
      flex: 1;
      min-width: 150px;
    }

    .alert {
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 20px;
      font-weight: 500;
    }

    .alert-success {
      background: #d4edda;
      color: #155724;
      border: 2px solid #c3e6cb;
    }

    .alert-error {
      background: #f8d7da;
      color: #721c24;
      border: 2px solid #f5c6cb;
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }

    .data-table th,
    .data-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #e0e0e0;
    }

    .data-table th {
      background: #f8f9fa;
      font-weight: 600;
      color: #495057;
    }

    .data-table tr:hover {
      background: #f8f9fa;
    }

    .mood-positive {
      color: #28a745;
      font-weight: bold;
    }

    .mood-negative {
      color: #dc3545;
      font-weight: bold;
    }

    .mood-neutral {
      color: #6c757d;
      font-weight: bold;
    }

    .loading {
      text-align: center;
      padding: 40px;
    }

    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .stat-box {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      padding: 25px;
      border-radius: 15px;
      text-align: center;
      border: 2px solid #dee2e6;
    }

    .stat-value {
      font-size: 42px;
      font-weight: bold;
      color: #667eea;
      margin-bottom: 10px;
    }

    .stat-label {
      font-size: 14px;
      color: #6c757d;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #6c757d;
    }

    /* ãƒ¢ãƒã‚¤ãƒ«å‘ã‘ã‚¿ãƒƒãƒå¼·åŒ– */
    input, .btn {
      -webkit-tap-highlight-color: rgba(0,0,0,0);
    }

    @media (max-width: 600px) {
      .login-card, .card {
        padding: 20px;
        border-radius: 14px;
      }

      input[type="text"], input[type="password"] {
        font-size: 18px;
        padding: 14px;
      }

      .btn {
        min-height: 56px;
        font-size: 16px;
      }
    }

    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <!-- ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ -->
  <div class="login-screen" id="loginScreen">
    <div class="login-card">
      <h1>ğŸ” ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³</h1>
      <div class="input-group">
        <label for="passwordInput">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
        <input type="password" id="passwordInput" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›" onkeypress="handleLoginKeypress(event)">
      </div>
      <button class="btn btn-primary" onclick="login()">ãƒ­ã‚°ã‚¤ãƒ³</button>
      <div id="loginError" style="color: #dc3545; margin-top: 15px; text-align: center; display: none;"></div>
    </div>
  </div>

  <!-- ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ -->
  <div class="dashboard" id="dashboard">
    <div class="header">
      <h1>ğŸŒŠ MoodFlow ç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
      <button class="logout-btn" onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </div>

    <div id="alertContainer"></div>

    <!-- ã‚»ãƒƒã‚·ãƒ§ãƒ³é¸æŠ -->
    <div class="card">
      <h2>ğŸ“‹ ã‚»ãƒƒã‚·ãƒ§ãƒ³é¸æŠ</h2>
      <div class="input-group">
        <label for="sessionIdInput">ã‚»ãƒƒã‚·ãƒ§ãƒ³ID</label>
        <input type="text" id="sessionIdInput" placeholder="ä¾‹: meeting-001">
      </div>
      <div class="controls">
        <button class="btn btn-primary" onclick="loadSession()">ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿</button>
        <button class="btn btn-success" onclick="generateSlides()" id="generateBtn">ã‚¹ãƒ©ã‚¤ãƒ‰ç”Ÿæˆ</button>
      </div>
    </div>

    <!-- çµ±è¨ˆæƒ…å ± -->
    <div id="statsContainer" style="display: none;">
      <div class="stats-grid">
        <div class="stat-box">
          <div class="stat-value" id="statTotal">0</div>
          <div class="stat-label">ç·ç™ºè¨€æ•°</div>
        </div>
        <div class="stat-box">
          <div class="stat-value" id="statParticipants">0</div>
          <div class="stat-label">å‚åŠ è€…æ•°</div>
        </div>
        <div class="stat-box">
          <div class="stat-value" id="statAverage">0</div>
          <div class="stat-label">å¹³å‡ã‚¹ã‚³ã‚¢</div>
        </div>
        <div class="stat-box">
          <div class="stat-value" id="statPositive">0%</div>
          <div class="stat-label">ãƒã‚¸ãƒ†ã‚£ãƒ–ç‡</div>
        </div>
      </div>
    </div>

    <!-- ãƒ‡ãƒ¼ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ« -->
    <div class="card" id="dataContainer" style="display: none;">
      <h2>ğŸ’¬ ç™ºè¨€ãƒ‡ãƒ¼ã‚¿</h2>
      <div id="dataTable"></div>
    </div>
  </div>

  <script>
    let authToken = null;
    let currentSessionId = null;
    let currentData = null;

    // ãƒ­ã‚°ã‚¤ãƒ³
    async function login() {
      const password = document.getElementById('passwordInput').value;

      if (!password) {
        showLoginError('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      try {
        const response = await fetch('/api/admin-login', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ password })
        });

        const result = await response.json();

        if (result.success) {
          authToken = result.token;
          localStorage.setItem('moodflow_admin_token', authToken);
          showDashboard();
        } else {
          showLoginError('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“');
        }
      } catch (error) {
        showLoginError('ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼: ' + error.message);
      }
    }

    // Enterã‚­ãƒ¼ã§ãƒ­ã‚°ã‚¤ãƒ³
    function handleLoginKeypress(event) {
      if (event.key === 'Enter') {
        login();
      }
    }

    // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
    function logout() {
      authToken = null;
      localStorage.removeItem('moodflow_admin_token');
      document.getElementById('loginScreen').style.display = 'flex';
      document.getElementById('dashboard').classList.remove('active');
      document.getElementById('passwordInput').value = '';
    }

    // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰è¡¨ç¤º
    function showDashboard() {
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('dashboard').classList.add('active');
    }

    // ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
    function showLoginError(message) {
      const errorDiv = document.getElementById('loginError');
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
    }

    // ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
    async function loadSession() {
      const sessionId = document.getElementById('sessionIdInput').value.trim();

      if (!sessionId) {
        showAlert('ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
        return;
      }

      currentSessionId = sessionId;

      try {
        const response = await fetch(`/api/get-session-data?sessionId=${sessionId}`, {
          headers: {
            'Authorization': `Bearer ${authToken}`
          }
        });

        const result = await response.json();

        if (result.success) {
          currentData = result.data;
          displayData(result.data);
          showAlert('ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ', 'success');
        } else {
          showAlert(result.error || 'ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
        }
      } catch (error) {
        showAlert('ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
      }
    }

    // ãƒ‡ãƒ¼ã‚¿è¡¨ç¤º
    function displayData(data) {
      // çµ±è¨ˆæƒ…å ±
      const stats = calculateStats(data);
      document.getElementById('statTotal').textContent = stats.total;
      document.getElementById('statParticipants').textContent = stats.participants;
      document.getElementById('statAverage').textContent = stats.average.toFixed(2);
      document.getElementById('statPositive').textContent = stats.positiveRate.toFixed(1) + '%';

      document.getElementById('statsContainer').style.display = 'block';
      document.getElementById('dataContainer').style.display = 'block';

      // ãƒ‡ãƒ¼ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ«
      const tableDiv = document.getElementById('dataTable');

      if (data.length === 0) {
        tableDiv.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ“­</div>
            <p>ã¾ã ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>
          </div>
        `;
        return;
      }

      let tableHTML = `
        <table class="data-table">
          <thead>
            <tr>
              <th>æ™‚åˆ»</th>
              <th>ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ </th>
              <th>ã‚¹ã‚³ã‚¢</th>
              <th>ã‚³ãƒ¡ãƒ³ãƒˆ</th>
            </tr>
          </thead>
          <tbody>
      `;

      data.forEach(row => {
        const moodClass = row.moodScore > 0 ? 'mood-positive' : row.moodScore < 0 ? 'mood-negative' : 'mood-neutral';
        const scoreText = row.moodScore > 0 ? `+${row.moodScore}` : row.moodScore;

        tableHTML += `
          <tr>
            <td>${new Date(row.timestamp).toLocaleString('ja-JP')}</td>
            <td><strong>${row.nickname}</strong></td>
            <td class="${moodClass}">${row.emoticon} ${scoreText}</td>
            <td>${row.comment || '-'}</td>
          </tr>
        `;
      });

      tableHTML += '</tbody></table>';
      tableDiv.innerHTML = tableHTML;
    }

    // çµ±è¨ˆè¨ˆç®—
    function calculateStats(data) {
      if (data.length === 0) {
        return { total: 0, participants: 0, average: 0, positiveRate: 0 };
      }

      const total = data.length;
      const participants = new Set(data.map(d => d.nickname)).size;
      const scores = data.map(d => d.moodScore);
      const average = scores.reduce((a, b) => a + b, 0) / scores.length;
      const positive = scores.filter(s => s > 0).length;
      const positiveRate = (positive / total) * 100;

      return { total, participants, average, positiveRate };
    }

    // ã‚¹ãƒ©ã‚¤ãƒ‰ç”Ÿæˆ
    async function generateSlides() {
      if (!currentSessionId || !currentData) {
        showAlert('å…ˆã«ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„', 'error');
        return;
      }

      const generateBtn = document.getElementById('generateBtn');
      generateBtn.disabled = true;
      generateBtn.textContent = 'ã‚¹ãƒ©ã‚¤ãƒ‰ç”Ÿæˆä¸­...';

      try {
        const response = await fetch('/api/generate-slides', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${authToken}`
          },
          body: JSON.stringify({
            sessionId: currentSessionId,
            data: currentData
          })
        });

        const result = await response.json();

        if (result.success) {
          showAlert(`ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’ç”Ÿæˆã—ã¾ã—ãŸï¼`, 'success');

          // ã‚¹ãƒ©ã‚¤ãƒ‰URLã‚’è¡¨ç¤º
          if (result.slideUrl) {
            const alertDiv = showAlert(
              `ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’é–‹ã: <a href="${result.slideUrl}" target="_blank" style="color: #155724; text-decoration: underline;">Googleã‚¹ãƒ©ã‚¤ãƒ‰</a>`,
              'success'
            );
            alertDiv.innerHTML = `ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’ç”Ÿæˆã—ã¾ã—ãŸï¼<br><a href="${result.slideUrl}" target="_blank" style="color: #155724; text-decoration: underline; font-weight: bold;">ğŸ“Š Googleã‚¹ãƒ©ã‚¤ãƒ‰ã‚’é–‹ã</a>`;
          }
        } else {
          showAlert(result.error || 'ã‚¹ãƒ©ã‚¤ãƒ‰ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
        }
      } catch (error) {
        showAlert('ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
      } finally {
        generateBtn.disabled = false;
        generateBtn.textContent = 'ã‚¹ãƒ©ã‚¤ãƒ‰ç”Ÿæˆ';
      }
    }

    // ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤º
    function showAlert(message, type) {
      const container = document.getElementById('alertContainer');
      const alert = document.createElement('div');
      alert.className = `alert alert-${type}`;
      alert.innerHTML = message;
      container.appendChild(alert);

      setTimeout(() => {
        alert.remove();
      }, 5000);

      return alert;
    }

    // åˆæœŸåŒ–
    window.onload = function() {
      const savedToken = localStorage.getItem('moodflow_admin_token');
      if (savedToken) {
        authToken = savedToken;
        showDashboard();
      }
    };
  </script>
</body>
</html>
