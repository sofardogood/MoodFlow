# MoodFlow - Google Apps Script版 セットアップガイド

## 概要

MoodFlowは会議中の参加者の感情をリアルタイムで記録し、OpenAI APIを使って分析するシステムです。
Google Apps Script（GAS）版では、1つのHTMLファイルで参加者画面と管理者画面を切り替えて使用します。

## 必要なもの

1. Googleアカウント
2. OpenAI APIキー
3. Googleスプレッドシート
4. （オプション）Google Driveフォルダ

## セットアップ手順

### 1. Googleスプレッドシートの準備

1. 新しいGoogleスプレッドシートを作成
2. スプレッドシートのURLから **SPREADSHEET_ID** を取得:
   ```
   https://docs.google.com/spreadsheets/d/{ここがSPREADSHEET_ID}/edit
   ```
3. スプレッドシートIDをメモしておく

**注意**: シート名「MoodData」は自動的に作成されるので、手動で作成する必要はありません。

### 2. OpenAI APIキーの取得

1. [OpenAI Platform](https://platform.openai.com/) にアクセス
2. [API Keys](https://platform.openai.com/api-keys) ページを開く
3. **Create new secret key** をクリック
4. APIキーをコピー（`sk-proj-...` で始まる文字列）

### 3. Google Apps Scriptプロジェクトの作成

1. [Google Apps Script](https://script.google.com/) にアクセス
2. **新しいプロジェクト** をクリック
3. プロジェクト名を「MoodFlow」に変更

### 4. ファイルのアップロード

以下のファイルを作成します：

#### 4-1. Code.gs

1. デフォルトの `Code.gs` を開く
2. `gas/Code.gs` の内容をコピー&ペースト

#### 4-2. OpenAI.gs

1. **+** ボタン → **スクリプト** をクリック
2. ファイル名を「OpenAI」に変更
3. `gas/OpenAI.gs` の内容をコピー&ペースト

#### 4-3. SlidesGenerator.gs

1. **+** ボタン → **スクリプト** をクリック
2. ファイル名を「SlidesGenerator」に変更
3. `gas/SlidesGenerator.gs` の内容をコピー&ペースト

#### 4-4. index.html

1. **+** ボタン → **HTML** をクリック
2. ファイル名を「index」に変更
3. `gas/index.html` の内容をコピー&ペースト

### 5. スクリプトプロパティの設定

1. 左側のメニューから **⚙️ プロジェクトの設定** を開く
2. **スクリプトプロパティ** セクションまでスクロール
3. **スクリプトプロパティを追加** をクリックして以下を設定:

| プロパティ | 値 | 説明 |
|----------|-----|------|
| `OPENAI_API_KEY` | `sk-proj-...` | OpenAI APIキー |
| `SPREADSHEET_ID` | `1ABC...` | スプレッドシートのID |
| `ADMIN_PASSWORD` | 任意のパスワード | 管理者ダッシュボードのパスワード |
| `GOOGLE_SLIDES_FOLDER_ID` | フォルダID（オプション） | スライドを保存するフォルダのID |

#### フォルダIDの取得方法（オプション）

1. Google Driveでフォルダを作成
2. フォルダを開く
3. URLから以下の部分を取得:
   ```
   https://drive.google.com/drive/folders/{ここがFOLDER_ID}
   ```

### 6. デプロイ

1. 右上の **デプロイ** → **新しいデプロイ** をクリック
2. **種類の選択** → **ウェブアプリ** を選択
3. 以下の設定を行う:
   - **説明**: MoodFlow
   - **次のユーザーとして実行**: 自分
   - **アクセスできるユーザー**: 全員
4. **デプロイ** をクリック
5. **アクセスを承認** をクリックして、必要な権限を許可
6. **ウェブアプリのURL** をコピー

このURLが参加者がアクセスするURLになります！

### 7. 権限の承認

初回実行時に以下の権限を承認する必要があります：

- Google Spreadsheetへのアクセス
- Google Slidesへのアクセス
- Google Driveへのアクセス
- 外部サービス（OpenAI API）への接続

## 使い方

### 参加者として使用

1. デプロイしたウェブアプリのURLにアクセス
2. **セッションID** と **ニックネーム** を入力
   - セッションID: 例 `meeting-2024-01-15`
   - ニックネーム: 例 `キリンさん`
3. スライダーで気分スコアを選択（-5〜+5）
4. （オプション）絵文字とコメントを追加
5. **送信** ボタンをクリック

**特徴**:
- セッションIDとニックネームはLocalStorageに保存されるので、2回目以降は自動入力されます
- 送信後、最新5件の履歴が表示されます
- スマホでも使いやすいレスポンシブデザイン

### 管理者として使用

1. 参加者画面の **管理者ログイン** ボタンをクリック
2. スクリプトプロパティで設定したパスワードを入力
3. ログイン後、**セッションID** を入力
4. **データを読み込む** をクリック
5. 統計情報とデータ一覧が表示されます
6. **📊 スライドを生成** をクリックして分析スライドを作成

**統計情報**:
- 総発言数
- 参加者数
- 平均スコア
- ポジティブ率

**生成されるスライド**:
1. タイトルスライド（セッション情報、統計）
2. サマリースライド（AIによる全体分析）
3. 統計スライド（詳細な数値）
4. 参加者別分析（個人ごとの発言数、平均スコア、トレンド）
5. 時系列分析（5分間隔の感情変化）
6. 推奨アクション（AIによる提案）

## トラブルシューティング

### 「認証が必要です」エラー

**原因**: 管理者ログインが必要です

**解決方法**:
1. 「管理者ログイン」から再度ログイン
2. パスワードが正しいか確認

### 「スプレッドシートへの書き込みに失敗しました」エラー

**原因**: SPREADSHEET_IDが正しくない、または権限がない

**解決方法**:
1. スクリプトプロパティのSPREADSHEET_IDを確認
2. スプレッドシートが存在するか確認
3. デプロイ時に権限を承認したか確認

### OpenAI APIエラー

**原因**: APIキーが無効、または使用量制限

**解決方法**:
1. OPENAI_API_KEYが正しいか確認
2. [OpenAI Usage](https://platform.openai.com/usage) で使用状況を確認
3. APIキーが有効か確認

**注意**: OpenAI APIが失敗しても、スライドは生成されます（デフォルトの分析内容が使用されます）

### スライドがフォルダに移動されない

**原因**: フォルダIDが正しくない、または権限がない

**解決方法**:
1. GOOGLE_SLIDES_FOLDER_IDを確認
2. フォルダが存在するか確認
3. フォルダへのアクセス権限があるか確認

**注意**: フォルダ移動に失敗してもスライドは生成されます（マイドライブのルートに保存されます）

## コスト

### OpenAI API

- モデル: gpt-4o-mini
- 1回の分析あたり: 約$0.001〜$0.01（データ量による）
- 月間100回の分析でも $1 以下

### Google Apps Script

- 無料枠で十分利用可能
- 制限:
  - 1日あたりのスクリプト実行時間: 90分
  - URLFetch呼び出し: 1日20,000回
  - スクリプト実行時間（1回あたり）: 6分

## セキュリティ

1. **管理者パスワード**: 強力なパスワードを設定してください
2. **スクリプトプロパティ**: APIキーは必ずスクリプトプロパティに保存（コードに直接書かない）
3. **デプロイURL**: 参加者にのみ共有してください
4. **定期的な確認**: スプレッドシートのデータを定期的に確認してください

## 更新方法

1. Google Apps Scriptエディタで該当ファイルを開く
2. コードを更新
3. **保存** をクリック
4. **デプロイ** → **デプロイを管理** → **✏️ 編集** → **バージョン: 新バージョン** → **デプロイ**

HTMLの変更は自動的に反映されます（再デプロイ不要）。

## サポート

問題が発生した場合は、以下を確認してください：

1. スクリプトプロパティが正しく設定されているか
2. デプロイ時に必要な権限を承認したか
3. ブラウザのコンソールにエラーが表示されていないか（F12キーで開く）
4. Google Apps Scriptの実行ログを確認（左側メニュー「実行数」）

---

これで MoodFlow の GAS版のセットアップは完了です！
会議中の感情をリアルタイムで記録し、AIによる分析で会議の質を向上させましょう 🌊
