<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>MoodFlow - ä¼šè­°æ„Ÿæƒ…åˆ†æ</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Sans', sans-serif;
      padding: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      background-size: 100% 80px;
      background-repeat: no-repeat;
      background-color: #ffffff;
      background-attachment: fixed;
      min-height: 100vh;
    }

    .container {
      padding: 0;
      max-width: 100%;
      margin: 0 auto;
    }

    .card {
      background: white;
      padding: 24px 0 80px 0;
      border-radius: 0;
      box-shadow: none;
      margin-bottom: 0;
      min-height: 100vh;
    }

    /* ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰è¡¨ç¤ºæ™‚ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯¾å¿œ */
    body.keyboard-open .card {
      min-height: auto;
    }

    h1 {
      font-size: 40px;
      line-height: 1.3;
      margin-bottom: 16px;
      padding: 0 16px;
      color: #667eea;
      text-align: center;
    }

    h2 {
      font-size: 30px;
      line-height: 1.3;
      margin-bottom: 16px;
      padding: 0 16px;
      color: #333;
    }

    h3 {
      font-size: 24px;
      line-height: 1.4;
      padding: 0 16px;
    }

    h4 {
      font-size: 22px;
      line-height: 1.4;
      padding: 0 16px;
    }

    .subtitle {
      text-align: center;
      color: #666;
      font-size: 21px;
      margin-bottom: 32px;
      padding: 0 16px;
      line-height: 1.5;
    }

    .view {
      display: none;
    }

    .view.active {
      display: block;
    }

    .form-group {
      margin-bottom: 32px;
      padding: 0 16px;
    }

    label {
      display: block;
      font-size: 21px;
      margin-bottom: 16px;
      color: #555;
      font-weight: 600;
    }

    input, textarea, select {
      width: 100%;
      font-size: 22px;
      padding: 18px;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      transition: border-color 0.3s;
    }

    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: #667eea;
    }

    textarea {
      resize: vertical;
      min-height: 144px;
    }

    button {
      width: 100%;
      font-size: 22px;
      padding: 28px;
      min-height: 72px;
      font-weight: 700;
      border-radius: 16px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
    }

    button:active {
      transform: translateY(0);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .card > button {
      margin: 0 16px 16px 16px;
      width: calc(100% - 32px);
    }

    .secondary-btn {
      background: white;
      color: #667eea;
      border: 2px solid #667eea;
    }

    .secondary-btn:hover {
      background: #f5f7ff;
    }

    .slider-container {
      margin: 24px 0;
    }

    .slider {
      width: 100%;
      height: 16px;
      border-radius: 8px;
      background: linear-gradient(to right, #ff6b6b, #ffd93d, #6bcf7f);
      outline: none;
      -webkit-appearance: none;
    }

    .slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: white;
      cursor: pointer;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      border: 4px solid #667eea;
    }

    .slider::-moz-range-thumb {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: white;
      cursor: pointer;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      border: 4px solid #667eea;
    }

    .mood-display {
      text-align: center;
      font-size: 72px;
      margin: 32px 0;
    }

    .mood-value {
      text-align: center;
      font-size: 40px;
      margin-bottom: 16px;
      font-weight: 700;
      color: #667eea;
    }

    .emoticon-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 6px;
      margin: 24px 0;
    }

    .emoticon-btn {
      width: 100%;
      padding: 6px 4px;
      font-size: 20px;
      min-height: 32px;
      background: white;
      border: 3px solid #e0e0e0;
      border-radius: 16px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .emoticon-btn:hover {
      transform: scale(1.1);
      border-color: #667eea;
    }

    .emoticon-btn.selected {
      background: #667eea;
      border-color: #667eea;
      transform: scale(1.1);
    }

    #historyContainer,
    #history,
    #aiAnalysisContainer,
    #emotionDistributionContainer,
    #participantAnalysisContainer,
    #timelineContainer,
    #adminData {
      padding: 0 16px;
    }

    .history-item {
      padding: 24px;
      margin-bottom: 16px;
      border-radius: 16px;
      background: #f5f7ff;
    }

    .history-item strong {
      font-size: 20px;
      font-weight: 700;
    }

    .history-item > div:not(.history-time) {
      font-size: 19px;
      line-height: 1.6;
      margin-top: 8px;
    }

    .history-time {
      font-size: 16px;
      color: #999;
      margin-bottom: 8px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
      margin: 24px 0;
      padding: 0 16px;
    }

    .stat-card {
      background: #f5f7ff;
      padding: 24px;
      border-radius: 8px;
      text-align: center;
    }

    .stat-value {
      font-size: 42px;
      font-weight: 700;
      color: #667eea;
      margin-bottom: 8px;
    }

    .stat-label {
      font-size: 17px;
      line-height: 1.4;
      color: #666;
    }

    .data-table-wrapper {
      padding: 0 16px;
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
      margin: 24px 0;
      font-size: 16px;
    }

    .data-table th,
    .data-table td {
      padding: 14px 10px;
      line-height: 1.5;
      text-align: left;
      border-bottom: 1px solid #e0e0e0;
    }

    .data-table th {
      background: #f5f7ff;
      font-size: 15px;
      font-weight: 700;
      color: #667eea;
    }

    .message {
      padding: 18px;
      margin: 0 16px 24px 16px;
      font-size: 17px;
      line-height: 1.6;
      border-radius: 12px;
      text-align: center;
    }

    .message.success {
      background: #d4edda;
      color: #155724;
    }

    .message.error {
      background: #f8d7da;
      color: #721c24;
    }

    .loading {
      text-align: center;
      padding: 40px 16px;
      font-size: 17px;
      line-height: 1.6;
      color: #667eea;
    }

    .loading > div {
      font-size: 19px !important;
      line-height: 1.6 !important;
      font-weight: 600 !important;
    }

    .spinner {
      border: 5px solid #f3f3f3;
      border-top: 5px solid #667eea;
      border-radius: 50%;
      width: 44px;
      height: 44px;
      animation: spin 1s linear infinite;
      margin: 0 auto 24px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .nav-buttons {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 24px;
      padding: 0 16px;
    }

    .nav-buttons button {
      width: 100%;
      min-height: 56px;
    }

    /* ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ä¸‹ã®èª¬æ˜æ–‡å­— */
    .slider-container + div {
      font-size: 17px !important;
      margin-top: 10px !important;
    }

    /* ã‚»ãƒƒã‚·ãƒ§ãƒ³IDãƒ’ãƒ³ãƒˆ */
    #sessionIdsHint {
      font-size: 15px !important;
    }

    #sessionIdsHint strong {
      font-size: 16px !important;
    }

    /* AIåˆ†æã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®æœ€é©åŒ– */
    #aiAnalysisContent {
      padding: 20px 16px !important;
    }

    #aiAnalysisContent h3 {
      font-size: 19px !important;
      margin-bottom: 12px !important;
      line-height: 1.4 !important;
      font-weight: 700 !important;
    }

    #aiAnalysisContent p,
    #aiAnalysisContent li {
      font-size: 18px !important;
      line-height: 1.7 !important;
    }

    #aiAnalysisContent ul {
      padding-left: 0 !important;
    }

    #aiAnalysisContent li {
      padding: 12px 0 !important;
    }

    #aiAnalysisContent > div {
      margin-bottom: 24px !important;
    }

    /* å††ã‚°ãƒ©ãƒ•ã®æœ€é©åŒ– */
    #emotionDistributionContainer {
      padding: 20px 16px !important;
    }

    #emotionDistributionContainer h3 {
      font-size: 19px !important;
      margin-bottom: 16px !important;
      line-height: 1.4 !important;
      font-weight: 700 !important;
    }

    #emotionDistributionContainer h4 {
      font-size: 17px !important;
      margin-bottom: 12px !important;
      line-height: 1.4 !important;
      font-weight: 600 !important;
    }

    #emotionDistributionContainer canvas {
      width: 180px !important;
      height: 180px !important;
    }

    #emotionDistributionContainer > div > div {
      flex-direction: column !important;
      gap: 24px !important;
    }

    #emotionDistributionContainer > div > div > div {
      min-width: 180px !important;
    }

    /* å‚åŠ è€…ãƒˆãƒ¬ãƒ³ãƒ‰ã®æœ€é©åŒ– */
    #participantInsights {
      padding: 20px 16px !important;
    }

    #participantInsights h3 {
      font-size: 19px !important;
      line-height: 1.4 !important;
      font-weight: 700 !important;
      margin-bottom: 16px !important;
    }

    #participantTrendsList > div {
      padding: 16px !important;
      font-size: 18px !important;
      line-height: 1.6 !important;
      margin-bottom: 12px !important;
    }

    #participantTrendsList strong {
      font-size: 18px !important;
    }

    #participantTrendsList span {
      font-size: 16px !important;
    }

    #participantTrendsList > div > div > div:first-child {
      font-size: 18px !important;
    }

    #participantTrendsList > div > div > div:last-child > div:first-child {
      font-size: 24px !important;
    }

    #participantTrendsList > div > div > div:last-child > div:last-child {
      font-size: 14px !important;
    }

    /* ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã®æœ€é©åŒ– */
    #timelineInsights {
      padding: 20px 16px !important;
    }

    #timelineInsights h3 {
      font-size: 19px !important;
      line-height: 1.4 !important;
      font-weight: 700 !important;
      margin-bottom: 16px !important;
    }

    #timelineChart > div {
      font-size: 16px !important;
      line-height: 1.5 !important;
      margin-bottom: 12px !important;
    }

    #timelineChart span {
      font-size: 15px !important;
    }

    #timelineChart > div > div:first-child > span:first-child {
      min-width: 70px !important;
      font-size: 14px !important;
    }

    #timelineChart > div > div:first-child > span:last-child {
      min-width: 70px !important;
      font-size: 16px !important;
      font-weight: 700 !important;
    }

    /* å††ã‚°ãƒ©ãƒ•ã®çµ±è¨ˆæƒ…å ± */
    [id^="pieStats"] {
      font-size: 15px !important;
      line-height: 1.6 !important;
    }

    [id^="pieStats"] span {
      font-size: 15px !important;
    }

    [id^="pieStats"] > div > div {
      gap: 8px !important;
    }

    [id^="pieStats"] > div > div > div {
      width: 14px !important;
      height: 14px !important;
    }

    /* ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆå‘ã‘ */
    @media (min-width: 600px) and (max-width: 1024px) {
      .container {
        max-width: 90%;
        margin: 0 auto;
      }

      .card {
        border-radius: 20px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.15);
        margin: 24px auto;
      }

      h1 {
        font-size: 42px;
      }

      h2 {
        font-size: 32px;
      }

      .subtitle {
        font-size: 22px;
      }

      label {
        font-size: 22px;
      }

      input, textarea, select {
        font-size: 22px;
        padding: 18px;
      }

      button {
        font-size: 22px;
        padding: 28px;
        min-height: 72px;
      }

      .emoticon-btn {
        font-size: 24px;
        padding: 6px 6px;
        min-height: 32px;
      }

      .emoticon-grid {
        grid-template-columns: repeat(5, 1fr);
        gap: 8px;
      }

      .form-group {
        margin-bottom: 40px;
        padding: 0 24px;
      }

      .card > button {
        margin: 0 24px 16px 24px;
        width: calc(100% - 48px);
      }

      .nav-buttons {
        padding: 0 24px;
        gap: 16px;
      }

      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    /* ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—å‘ã‘ */
    @media (min-width: 1025px) {
      .container {
        max-width: 95%;
        margin: 0 auto;
      }

      .card {
        border-radius: 24px;
        box-shadow: 0 15px 50px rgba(0,0,0,0.15);
        margin: 32px auto;
        padding: 32px 0 100px 0;
      }

      h1 {
        font-size: 48px;
        margin-bottom: 20px;
      }

      h2 {
        font-size: 36px;
        margin-bottom: 24px;
      }

      h3 {
        font-size: 28px;
      }

      h4 {
        font-size: 24px;
      }

      .subtitle {
        font-size: 24px;
        margin-bottom: 40px;
      }

      label {
        font-size: 22px;
        margin-bottom: 18px;
      }

      input, textarea, select {
        font-size: 24px;
        padding: 20px;
      }

      button {
        font-size: 24px;
        padding: 32px;
        min-height: 80px;
      }

      .emoticon-btn {
        font-size: 32px;
        padding: 8px 8px;
        min-height: 40px;
      }

      .emoticon-grid {
        grid-template-columns: repeat(5, 1fr);
        gap: 10px;
      }

      .form-group {
        margin-bottom: 48px;
        padding: 0 32px;
      }

      .card > button {
        margin: 0 32px 16px 32px;
        width: calc(100% - 64px);
      }

      .nav-buttons {
        padding: 0 32px;
        gap: 20px;
      }

      .stats-grid {
        grid-template-columns: repeat(4, 1fr);
        gap: 24px;
      }

      .mood-value {
        font-size: 80px;
        margin: 40px 0;
      }

      .slider-container {
        margin: 32px 0;
      }

      .slider {
        height: 20px;
      }

      .data-table th,
      .data-table td {
        padding: 18px 14px;
        font-size: 18px;
      }

      .data-table th {
        font-size: 18px;
      }

      .history-item {
        padding: 28px;
        margin-bottom: 20px;
      }

      .history-item strong {
        font-size: 24px;
      }

      .history-item > div:not(.history-time) {
        font-size: 22px;
      }

      .history-time {
        font-size: 18px;
      }

      #historyContainer,
      #history,
      #aiAnalysisContainer,
      #emotionDistributionContainer,
      #participantAnalysisContainer,
      #timelineContainer,
      #adminData {
        padding: 0 32px;
      }

      #aiAnalysisContent {
        padding: 24px 32px !important;
      }

      #aiAnalysisContent h3 {
        font-size: 24px !important;
      }

      #aiAnalysisContent p,
      #aiAnalysisContent li {
        font-size: 20px !important;
      }

      #emotionDistributionContainer h3 {
        font-size: 24px !important;
      }

      #emotionDistributionContainer h4 {
        font-size: 20px !important;
      }

      #emotionDistributionContainer canvas {
        width: 240px !important;
        height: 240px !important;
      }

      #participantInsights h3 {
        font-size: 24px !important;
      }

      #participantTrendsList > div {
        padding: 18px !important;
        font-size: 20px !important;
      }

      #timelineInsights h3 {
        font-size: 24px !important;
      }

      #timelineChart > div {
        font-size: 18px !important;
      }
    }

    /* ãƒ¢ãƒã‚¤ãƒ«å‘ã‘ã®è¿½åŠ æ”¹å–„ */
    input, textarea, button {
      -webkit-tap-highlight-color: rgba(0,0,0,0);
    }

    @media (max-width: 600px) {
      input, textarea {
        font-size: 18px;
        padding: 14px;
      }

      .emoticon-btn {
        font-size: 36px;
        padding: 18px 12px;
        min-height: 64px;
      }

      /* ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã§å…¥åŠ›æ¬„ãŒéš ã‚Œã«ããã™ã‚‹ */
      input:focus, textarea:focus {
        scroll-margin-bottom: 220px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- å‚åŠ è€…å…¥åŠ›ç”»é¢ -->
    <div id="participantView" class="view active">
      <div class="card">
        <h1>ğŸŒŠ MoodFlow</h1>
        <p class="subtitle">ä¼šè­°ä¸­ã®æ„Ÿæƒ…ã‚’è¨˜éŒ²ã—ã¾ã—ã‚‡ã†</p>

        <div id="participantMessage"></div>

        <div class="form-group">
          <label>ã‚»ãƒƒã‚·ãƒ§ãƒ³ID</label>
          <input type="text" id="sessionId" placeholder="ä¾‹: meeting-2024-01-15">
        </div>

        <div class="form-group">
          <label>ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ </label>
          <input type="text" id="nickname" placeholder="ä¾‹: ã‚­ãƒªãƒ³ã•ã‚“">
        </div>

        <div class="form-group">
          <label>ä»Šã®æ°—åˆ†ã¯ï¼Ÿ</label>
          <div class="mood-value" id="moodValue">0</div>
          <div class="slider-container">
            <input type="range" min="-5" max="5" value="0" class="slider" id="moodSlider">
          </div>
          <div style="display: flex; justify-content: space-between; font-size: 12px; color: #999;">
            <span>ğŸ˜¢ -5</span>
            <span>ğŸ˜ 0</span>
            <span>ğŸ˜Š +5</span>
          </div>
        </div>

        <div class="form-group">
          <label>çµµæ–‡å­—ã‚’é¸æŠï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰</label>
          <div class="emoticon-grid" id="emoticonGrid">
            <button class="emoticon-btn" data-emoticon="ğŸ˜Š">ğŸ˜Š</button>
            <button class="emoticon-btn" data-emoticon="ğŸ˜„">ğŸ˜„</button>
            <button class="emoticon-btn" data-emoticon="ğŸ˜">ğŸ˜</button>
            <button class="emoticon-btn" data-emoticon="ğŸ˜Ÿ">ğŸ˜Ÿ</button>
            <button class="emoticon-btn" data-emoticon="ğŸ˜¢">ğŸ˜¢</button>
            <button class="emoticon-btn" data-emoticon="ğŸ‘">ğŸ‘</button>
            <button class="emoticon-btn" data-emoticon="â¤ï¸">â¤ï¸</button>
            <button class="emoticon-btn" data-emoticon="ğŸ¤”">ğŸ¤”</button>
            <button class="emoticon-btn" data-emoticon="ğŸ’¡">ğŸ’¡</button>
            <button class="emoticon-btn" data-emoticon="ğŸ‰">ğŸ‰</button>
          </div>
        </div>

        <div class="form-group">
          <label>ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰</label>
          <textarea id="comment" placeholder="ä»Šã®æ°—æŒã¡ã‚„æ„è¦‹ã‚’è‡ªç”±ã«å…¥åŠ›ã—ã¦ãã ã•ã„"></textarea>
        </div>

        <div class="form-group">
          <label>ç™ºè¡¨è€…ã¸ã®è³ªå•ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰</label>
          <textarea id="question" placeholder="ç™ºè¡¨è€…ã«è³ªå•ãŒã‚ã‚Œã°ã“ã“ã«å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹ï¼šãªãœåœ°çƒã¯ä¸¸ã„ã®ã§ã™ã‹ï¼Ÿï¼‰"></textarea>
        </div>

        <button onclick="submitMood()" id="submitBtn">é€ä¿¡</button>

        <div class="nav-buttons">
          <button class="secondary-btn" onclick="showAdminLogin()">ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³</button>
          <button class="secondary-btn" onclick="showFAQ()" style="background: #667eea; color: white; border: 2px solid #667eea;">â“ ã‚ˆãã‚ã‚‹è³ªå•</button>
        </div>

        <div id="historyContainer" style="margin-top: 30px; display: none;">
          <h2>é€ä¿¡å±¥æ­´</h2>
          <div id="history"></div>
        </div>
      </div>
    </div>

    <!-- ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ -->
    <div id="loginView" class="view">
      <div class="card">
        <h1>ğŸ”’ ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³</h1>
        <p class="subtitle">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>

        <div id="loginMessage"></div>

        <div class="form-group">
          <label>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
          <input type="password" id="adminPassword" placeholder="ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
        </div>

        <button onclick="login()">ãƒ­ã‚°ã‚¤ãƒ³</button>

        <div class="nav-buttons">
          <button class="secondary-btn" onclick="showParticipantView()">å‚åŠ è€…ç”»é¢ã«æˆ»ã‚‹</button>
        </div>
      </div>
    </div>

    <!-- ç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ -->
    <div id="adminView" class="view">
      <div class="card">
        <h1>ğŸ“Š ç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
        <p class="subtitle">ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã®ç¢ºèªã¨åˆ†æ</p>

        <div id="adminMessage"></div>

        <div class="form-group">
          <label>ã‚»ãƒƒã‚·ãƒ§ãƒ³ID</label>
          <input type="text" id="adminSessionId" placeholder="ä¾‹: meeting-2024-01-15">
          <div id="sessionIdsHint" style="margin-top: 10px; font-size: 12px; color: #666;"></div>
        </div>

        <button onclick="loadSessionData()">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€</button>

        <button class="secondary-btn" onclick="loadAvailableSessionIds()" style="margin-top: 10px;">
          ğŸ“‹ åˆ©ç”¨å¯èƒ½ãªã‚»ãƒƒã‚·ãƒ§ãƒ³IDã‚’è¡¨ç¤º
        </button>

        <button class="secondary-btn" onclick="testAPIConnection()" style="margin-top: 10px;">
          ğŸ”§ OpenAI APIæ¥ç¶šãƒ†ã‚¹ãƒˆ
        </button>

        <div id="aiAnalysisContainer" style="display: none; margin-top: 30px;">
          <h2>ğŸ¤– AIåˆ†æçµæœ</h2>
          <div id="aiAnalysisContent" style="background: #f5f7ff; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
            <div id="overallMood" style="margin-bottom: 20px;">
              <h3 style="color: #667eea; margin-bottom: 10px;">ğŸ“Š å…¨ä½“ã®é›°å›²æ°—</h3>
              <p id="overallMoodText" style="font-size: 16px; line-height: 1.6;"></p>
            </div>

            <div id="timeProgression" style="margin-bottom: 20px;">
              <h3 style="color: #667eea; margin-bottom: 10px;">â° æ™‚é–“çµŒéã«ä¼´ã†å¤‰åŒ–</h3>
              <p id="timeProgressionText" style="font-size: 16px; line-height: 1.6; background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #667eea;"></p>
            </div>

            <div id="keyInsights" style="margin-bottom: 20px;">
              <h3 style="color: #667eea; margin-bottom: 10px;">ğŸ’¡ ä¸»ãªã‚¤ãƒ³ã‚µã‚¤ãƒˆ</h3>
              <ul id="keyInsightsList" style="list-style: none; padding: 0;"></ul>
            </div>

            <div id="positiveHighlights" style="margin-bottom: 20px;">
              <h3 style="color: #667eea; margin-bottom: 10px;">âœ… ãƒã‚¸ãƒ†ã‚£ãƒ–ãªç‚¹</h3>
              <ul id="positiveHighlightsList" style="list-style: none; padding: 0;"></ul>
            </div>

            <div id="concerns" style="margin-bottom: 20px;">
              <h3 style="color: #667eea; margin-bottom: 10px;">âš ï¸ æ‡¸å¿µäº‹é …</h3>
              <ul id="concernsList" style="list-style: none; padding: 0;"></ul>
            </div>

            <div id="speakerAdvice" style="margin-bottom: 20px;">
              <h3 style="color: #667eea; margin-bottom: 10px;">ğŸ¤ ç™»å£‡è€…ã¸ã®å…·ä½“çš„ã‚¢ãƒ‰ãƒã‚¤ã‚¹</h3>
              <ul id="speakerAdviceList" style="list-style: none; padding: 0;"></ul>
            </div>

            <div id="recommendations">
              <h3 style="color: #667eea; margin-bottom: 10px;">ğŸ¯ æ¬¡å›ã«å‘ã‘ãŸæ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</h3>
              <ul id="recommendationsList" style="list-style: none; padding: 0;"></ul>
            </div>
          </div>

          <div id="emotionDistributionContainer" style="background: #f5f7ff; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
            <h3 style="color: #667eea; margin-bottom: 15px;">ğŸ“Š æ™‚é–“å¸¯åˆ¥ã®æ„Ÿæƒ…åˆ†å¸ƒ</h3>
            <div style="display: flex; justify-content: space-around; flex-wrap: wrap; gap: 20px;">
              <div style="text-align: center; flex: 1; min-width: 200px;">
                <h4 style="color: #555; margin-bottom: 10px;">åºç›¤</h4>
                <canvas id="pieChart1" width="200" height="200"></canvas>
                <div id="pieStats1" style="margin-top: 10px; font-size: 12px; color: #666;"></div>
              </div>
              <div style="text-align: center; flex: 1; min-width: 200px;">
                <h4 style="color: #555; margin-bottom: 10px;">ä¸­ç›¤</h4>
                <canvas id="pieChart2" width="200" height="200"></canvas>
                <div id="pieStats2" style="margin-top: 10px; font-size: 12px; color: #666;"></div>
              </div>
              <div style="text-align: center; flex: 1; min-width: 200px;">
                <h4 style="color: #555; margin-bottom: 10px;">çµ‚ç›¤</h4>
                <canvas id="pieChart3" width="200" height="200"></canvas>
                <div id="pieStats3" style="margin-top: 10px; font-size: 12px; color: #666;"></div>
              </div>
            </div>
          </div>

          <div id="participantInsights" style="background: #f5f7ff; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
            <h3 style="color: #667eea; margin-bottom: 10px;">ğŸ‘¥ å‚åŠ è€…åˆ¥ãƒˆãƒ¬ãƒ³ãƒ‰</h3>
            <div id="participantTrendsList"></div>
          </div>

          <div id="timelineInsights" style="background: #f5f7ff; padding: 20px; border-radius: 10px;">
            <h3 style="color: #667eea; margin-bottom: 10px;">â±ï¸ æ™‚é–“å¸¯åˆ¥ã®æ„Ÿæƒ…æ¨ç§»</h3>
            <div id="timelineChart"></div>
          </div>
        </div>

        <div id="statsContainer" style="display: none; margin-top: 30px;">
          <h2>çµ±è¨ˆæƒ…å ±</h2>
          <div class="stats-grid" id="stats"></div>
        </div>

        <div id="dataContainer" style="display: none; margin-top: 30px;">
          <h2>ãƒ‡ãƒ¼ã‚¿ä¸€è¦§</h2>
          <div style="overflow-x: auto;">
            <table class="data-table" id="dataTable">
              <thead>
                <tr>
                  <th>æ™‚åˆ»</th>
                  <th>ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ </th>
                  <th>ã‚¹ã‚³ã‚¢</th>
                  <th>çµµæ–‡å­—</th>
                  <th>ã‚³ãƒ¡ãƒ³ãƒˆ</th>
                </tr>
              </thead>
              <tbody id="dataBody"></tbody>
            </table>
          </div>

          <button onclick="generateSlides()" id="generateBtn" style="margin-top: 20px;">
            ğŸ“Š ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’ç”Ÿæˆ
          </button>
        </div>

        <div id="questionsContainer" style="display: none; margin-top: 30px;">
          <h2>â“ å‚åŠ è€…ã‹ã‚‰ã®è³ªå•ä¸€è¦§</h2>
          <div style="background: #f5f7ff; padding: 20px; border-radius: 10px;">
            <div id="questionsList"></div>
            <div id="noQuestionsMessage" style="text-align: center; color: #999; padding: 20px;">
              è³ªå•ãŒã¾ã æŠ•ç¨¿ã•ã‚Œã¦ã„ã¾ã›ã‚“
            </div>
          </div>

          <button onclick="downloadQuestions()" class="secondary-btn" style="margin-top: 20px; background: #6bcf7f; color: white; border: 2px solid #6bcf7f;">
            ğŸ“¥ è³ªå•ã‚’CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          </button>
        </div>

        <div class="nav-buttons">
          <button class="secondary-btn" onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
          <button class="secondary-btn" onclick="showFAQ()" style="background: #667eea; color: white; border: 2px solid #667eea;">â“ ã‚ˆãã‚ã‚‹è³ªå•</button>
        </div>
      </div>
    </div>

    <!-- FAQã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div id="faqView" class="view">
      <div class="card">
        <h1>â“ ã‚ˆãã‚ã‚‹è³ªå•</h1>
        <p class="subtitle">MoodFlowã®ä½¿ã„æ–¹ã«ã¤ã„ã¦ã®ã”è³ªå•</p>

        <div class="form-group">
          <h2>ğŸ“± æ©Ÿèƒ½ãƒ»ãƒ‡ã‚¶ã‚¤ãƒ³é–¢é€£</h2>
          
          <div style="background: #f5f7ff; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
            <h3 style="color: #667eea; margin-bottom: 10px;">Q1: ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œã«ã¤ã„ã¦</h3>
            <p style="margin: 10px 0; color: #555;">ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãŒè¡¨ç¤ºã•ã‚Œã‚‹æ™‚ã«ç”»é¢ãŒã©ã®ã‚ˆã†ã«å‹•ä½œã—ã¾ã™ã‹ï¼Ÿ</p>
            <p style="margin: 10px 0; color: #555;">ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆã¨ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã§ã®è¡¨ç¤ºã¯æœ€é©åŒ–ã•ã‚Œã¦ã„ã¾ã™ã‹ï¼Ÿ</p>
          </div>

          <div style="background: #f5f7ff; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
            <h3 style="color: #667eea; margin-bottom: 10px;">Q2: æ°—åˆ†ã‚¹ã‚³ã‚¢ãƒ»çµµæ–‡å­—é¸æŠ</h3>
            <p style="margin: 10px 0; color: #555;">ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã® -5 ã‹ã‚‰ +5 ã®ç¯„å›²ã¯èª¿æ•´å¯èƒ½ã§ã™ã‹ï¼Ÿ</p>
            <p style="margin: 10px 0; color: #555;">çµµæ–‡å­—ã®ç¨®é¡ã‚’è¿½åŠ ãƒ»å¤‰æ›´ã—ãŸã„ã®ã§ã™ãŒã€ã©ã“ã§å¤‰æ›´ã—ã¾ã™ã‹ï¼Ÿ</p>
            <p style="margin: 10px 0; color: #555;">çµµæ–‡å­—é¸æŠã‚’å¿…é ˆã«ã™ã‚‹ã‹ã€ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®ã¾ã¾ã«ã™ã‚‹ã‹å¤‰æ›´ã§ãã¾ã™ã‹ï¼Ÿ</p>
          </div>

          <div style="background: #f5f7ff; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
            <h3 style="color: #667eea; margin-bottom: 10px;">Q3: é€ä¿¡å±¥æ­´ã®è¡¨ç¤º</h3>
            <p style="margin: 10px 0; color: #555;">å±¥æ­´ã¯ä½•ä»¶ã¾ã§è¡¨ç¤ºã•ã‚Œã¾ã™ã‹ï¼Ÿè¡¨ç¤ºä»¶æ•°ã‚’å¤‰æ›´ã§ãã¾ã™ã‹ï¼Ÿ</p>
            <p style="margin: 10px 0; color: #555;">éå»ã®é€ä¿¡å±¥æ­´ã‚’å…¨ä»¶ç¢ºèªã™ã‚‹æ–¹æ³•ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ</p>
          </div>

          <div style="background: #f5f7ff; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
            <h3 style="color: #667eea; margin-bottom: 10px;">Q4: è‰²ã¨ãƒ†ãƒ¼ãƒ</h3>
            <p style="margin: 10px 0; color: #555;">ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³è‰²ï¼ˆç´«ï¼‰ã‚’åˆ¥ã®è‰²ã«å¤‰æ›´ã—ãŸã„å ´åˆã€ã©ã“ã‚’ç·¨é›†ã—ã¾ã™ã‹ï¼Ÿ</p>
            <p style="margin: 10px 0; color: #555;">ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã«å¯¾å¿œã—ã¦ã„ã¾ã™ã‹ï¼Ÿ</p>
          </div>
        </div>

        <div class="form-group">
          <h2>ğŸ” ç®¡ç†è€…æ©Ÿèƒ½é–¢é€£</h2>

          <div style="background: #f5f7ff; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
            <h3 style="color: #667eea; margin-bottom: 10px;">Q5: ãƒ­ã‚°ã‚¤ãƒ³ãƒ»èªè¨¼</h3>
            <p style="margin: 10px 0; color: #555;">ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯ã©ã“ã§è¨­å®šã•ã‚Œã¦ã„ã¾ã™ã‹ï¼Ÿ</p>
            <p style="margin: 10px 0; color: #555;">è¤‡æ•°ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¯¾å¿œã¯ã§ãã¾ã™ã‹ï¼Ÿ</p>
          </div>

          <div style="background: #f5f7ff; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
            <h3 style="color: #667eea; margin-bottom: 10px;">Q6: ã‚»ãƒƒã‚·ãƒ§ãƒ³IDç®¡ç†</h3>
            <p style="margin: 10px 0; color: #555;">ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã®å‘½åãƒ«ãƒ¼ãƒ«ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿæ¨å¥¨å½¢å¼ã¯ï¼Ÿ</p>
            <p style="margin: 10px 0; color: #555;">æ—¢å­˜ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã™ã‹ï¼Ÿ</p>
          </div>

          <div style="background: #f5f7ff; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
            <h3 style="color: #667eea; margin-bottom: 10px;">Q7: AIåˆ†ææ©Ÿèƒ½</h3>
            <p style="margin: 10px 0; color: #555;">åˆå›åˆ†æã«1åˆ†ã‹ã‹ã‚‹ã®ã¯ä»•æ§˜ã§ã™ã‹ï¼Ÿé«˜é€ŸåŒ–ã§ãã¾ã™ã‹ï¼Ÿ</p>
            <p style="margin: 10px 0; color: #555;">åˆ†æçµæœã¯ã„ã¤ã¾ã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚Œã¾ã™ã‹ï¼Ÿ</p>
            <p style="margin: 10px 0; color: #555;">GPT-4oä»¥å¤–ã®ãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ç”¨ã§ãã¾ã™ã‹ï¼Ÿ</p>
          </div>

          <div style="background: #f5f7ff; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
            <h3 style="color: #667eea; margin-bottom: 10px;">Q8: ãƒ‡ãƒ¼ã‚¿ä¸€è¦§ãƒ»çµ±è¨ˆ</h3>
            <p style="margin: 10px 0; color: #555;">ãƒ‡ãƒ¼ã‚¿ä¸€è¦§ã‚’CSVã‚„Excelã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã§ãã¾ã™ã‹ï¼Ÿ</p>
            <p style="margin: 10px 0; color: #555;">ã‚°ãƒ©ãƒ•ã®æ™‚é–“å¸¯åˆ†å‰²ï¼ˆåºç›¤ãƒ»ä¸­ç›¤ãƒ»çµ‚ç›¤ï¼‰ã®æ™‚é–“ã¯èª¿æ•´ã§ãã¾ã™ã‹ï¼Ÿ</p>
          </div>
        </div>

        <div class="form-group">
          <h2>ğŸ“Š ã‚¹ãƒ©ã‚¤ãƒ‰ç”Ÿæˆé–¢é€£</h2>

          <div style="background: #f5f7ff; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
            <h3 style="color: #667eea; margin-bottom: 10px;">Q9: ã‚¹ãƒ©ã‚¤ãƒ‰æ©Ÿèƒ½</h3>
            <p style="margin: 10px 0; color: #555;">ç”Ÿæˆã•ã‚ŒãŸã‚¹ãƒ©ã‚¤ãƒ‰ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¯ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã§ãã¾ã™ã‹ï¼Ÿ</p>
            <p style="margin: 10px 0; color: #555;">ã‚¹ãƒ©ã‚¤ãƒ‰ã«ãƒ­ã‚´ã‚„ãƒ–ãƒ©ãƒ³ãƒ‰ã‚«ãƒ©ãƒ¼ã‚’åæ˜ ã§ãã¾ã™ã‹ï¼Ÿ</p>
          </div>
        </div>

        <div class="form-group">
          <h2>ğŸ”§ ãã®ä»–ãƒ»ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°</h2>

          <div style="background: #f5f7ff; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
            <h3 style="color: #667eea; margin-bottom: 10px;">Q10: ã‚¨ãƒ©ãƒ¼å‡¦ç†</h3>
            <p style="margin: 10px 0; color: #555;">ã€Œã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼ã€ãŒå‡ºãŸå ´åˆã€ã©ã†å¯¾å¿œã™ã‚Œã°ã„ã„ã§ã™ã‹ï¼Ÿ</p>
            <p style="margin: 10px 0; color: #555;">3å›ã®ãƒªãƒˆãƒ©ã‚¤ã§å¤±æ•—ã—ãŸå ´åˆã€ã©ã†ã™ã‚Œã°ã„ã„ã§ã™ã‹ï¼Ÿ</p>
          </div>

          <div style="background: #f5f7ff; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
            <h3 style="color: #667eea; margin-bottom: 10px;">Q11: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹</h3>
            <p style="margin: 10px 0; color: #555;">å¤§é‡ã®ãƒ‡ãƒ¼ã‚¿ï¼ˆ1000ä»¶ä»¥ä¸Šï¼‰ã‚’å‡¦ç†ã§ãã¾ã™ã‹ï¼Ÿ</p>
            <p style="margin: 10px 0; color: #555;">è¤‡æ•°ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’åŒæ™‚ã«ç®¡ç†ã§ãã¾ã™ã‹ï¼Ÿ</p>
          </div>

          <div style="background: #f5f7ff; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
            <h3 style="color: #667eea; margin-bottom: 10px;">Q12: ãƒ‡ãƒ¼ã‚¿ä¿å­˜</h3>
            <p style="margin: 10px 0; color: #555;">ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜ã•ã‚Œã‚‹ãƒ‡ãƒ¼ã‚¿ï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³IDã€ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ï¼‰ã¯ã€ã„ã¤å‰Šé™¤ã•ã‚Œã¾ã™ã‹ï¼Ÿ</p>
            <p style="margin: 10px 0; color: #555;">ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã¯ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ã©ã“ã«ä¿å­˜ã•ã‚Œã¦ã„ã¾ã™ã‹ï¼Ÿ</p>
          </div>
        </div>

        <div class="nav-buttons">
          <button class="secondary-btn" onclick="showParticipantView()">å‚åŠ è€…ç”»é¢ã«æˆ»ã‚‹</button>
          <button class="secondary-btn" onclick="showAdminLogin()">ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    let currentEmoticon = '';
    let authToken = '';
    let currentSessionData = [];

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚
    window.onload = function() {
      // LocalStorageã‹ã‚‰å€¤ã‚’å¾©å…ƒ
      const savedSessionId = localStorage.getItem('moodflow_session_id');
      const savedNickname = localStorage.getItem('moodflow_nickname');

      if (savedSessionId) document.getElementById('sessionId').value = savedSessionId;
      if (savedNickname) document.getElementById('nickname').value = savedNickname;

      // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆ
      document.getElementById('moodSlider').addEventListener('input', function(e) {
        document.getElementById('moodValue').textContent = e.target.value;
      });

      // çµµæ–‡å­—é¸æŠ
      document.querySelectorAll('.emoticon-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
          e.preventDefault();
          document.querySelectorAll('.emoticon-btn').forEach(b => b.classList.remove('selected'));
          this.classList.add('selected');
          currentEmoticon = this.dataset.emoticon;
        });
      });

      // ãƒ¢ãƒã‚¤ãƒ«ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ¤œå‡ºï¼ˆã‚¹ãƒãƒ›ã§ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãŒè¡¨ç¤ºã•ã‚ŒãŸæ™‚ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ã«ã™ã‚‹ï¼‰
      const inputs = document.querySelectorAll('input, textarea');
      let initialViewportHeight = window.visualViewport ? window.visualViewport.height : window.innerHeight;

      // å…¥åŠ›æ¬„ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ™‚
      inputs.forEach(input => {
        input.addEventListener('focus', function() {
          // ãƒ¢ãƒã‚¤ãƒ«ãƒ‡ãƒã‚¤ã‚¹ã®ã¿ï¼ˆç”»é¢å¹…ãŒ600pxä»¥ä¸‹ï¼‰
          if (window.innerWidth <= 600) {
            document.body.classList.add('keyboard-open');
          }
        });

        input.addEventListener('blur', function() {
          document.body.classList.remove('keyboard-open');
        });
      });

      // viewportå¤‰åŒ–æ¤œå‡ºï¼ˆã‚ˆã‚Šç¢ºå®Ÿãªã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ¤œå‡ºï¼‰
      if (window.visualViewport) {
        window.visualViewport.addEventListener('resize', function() {
          if (window.innerWidth <= 600) {
            const currentHeight = window.visualViewport.height;
            // viewportãŒç¸®å°ã—ãŸå ´åˆï¼ˆã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãŒè¡¨ç¤ºã•ã‚ŒãŸï¼‰
            if (currentHeight < initialViewportHeight * 0.75) {
              document.body.classList.add('keyboard-open');
            } else {
              document.body.classList.remove('keyboard-open');
            }
          }
        });
      }
    };

    // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
    function showView(viewId) {
      document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
      document.getElementById(viewId).classList.add('active');
    }

    function showParticipantView() {
      showView('participantView');
    }

    function showAdminLogin() {
      showView('loginView');
    }

    function showAdminView() {
      showView('adminView');
    }

    function showFAQ() {
      showView('faqView');
    }

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
    function showMessage(elementId, message, type) {
      const el = document.getElementById(elementId);
      el.innerHTML = `<div class="message ${type}">${message}</div>`;
      setTimeout(() => { el.innerHTML = ''; }, 5000);
    }

    function showLoading(elementId) {
      const el = document.getElementById(elementId);
      el.innerHTML = '<div class="loading"><div class="spinner"></div>å‡¦ç†ä¸­...</div>';
    }

    // æ„Ÿæƒ…ãƒ‡ãƒ¼ã‚¿é€ä¿¡
    function submitMood() {
      const sessionId = document.getElementById('sessionId').value.trim();
      const nickname = document.getElementById('nickname').value.trim();
      const moodScore = parseInt(document.getElementById('moodSlider').value);
      const comment = document.getElementById('comment').value.trim();
      const question = document.getElementById('question').value.trim();

      if (!sessionId || !nickname) {
        showMessage('participantMessage', 'ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã¨ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
        return;
      }

      // LocalStorageã«ä¿å­˜
      localStorage.setItem('moodflow_session_id', sessionId);
      localStorage.setItem('moodflow_nickname', nickname);

      const data = {
        sessionId: sessionId,
        nickname: nickname,
        moodScore: moodScore,
        comment: comment,
        emoticon: currentEmoticon,
        question: question
      };

      showLoading('participantMessage');
      document.getElementById('submitBtn').disabled = true;

      google.script.run
        .withSuccessHandler(function(result) {
          document.getElementById('submitBtn').disabled = false;

          if (result.success) {
            showMessage('participantMessage', 'âœ… é€ä¿¡ã—ã¾ã—ãŸï¼', 'success');

            // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('moodSlider').value = 0;
            document.getElementById('moodValue').textContent = '0';
            document.getElementById('comment').value = '';
            document.getElementById('question').value = '';
            document.querySelectorAll('.emoticon-btn').forEach(b => b.classList.remove('selected'));
            currentEmoticon = '';

            // å±¥æ­´ã«è¿½åŠ 
            addToHistory(data, result.timestamp);
          } else {
            showMessage('participantMessage', 'âŒ ã‚¨ãƒ©ãƒ¼: ' + result.error, 'error');
          }
        })
        .withFailureHandler(function(error) {
          document.getElementById('submitBtn').disabled = false;
          showMessage('participantMessage', 'âŒ ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
        })
        .submitMood(data);
    }

    // å±¥æ­´ã«è¿½åŠ 
    function addToHistory(data, timestamp) {
      const historyContainer = document.getElementById('historyContainer');
      const history = document.getElementById('history');

      historyContainer.style.display = 'block';

      const time = new Date(timestamp).toLocaleTimeString('ja-JP');
      const item = document.createElement('div');
      item.className = 'history-item';
      item.innerHTML = `
        <div class="history-time">${time}</div>
        <div><strong>${data.nickname}</strong> - ã‚¹ã‚³ã‚¢: ${data.moodScore} ${data.emoticon}</div>
        ${data.comment ? `<div style="margin-top: 5px; color: #666;">${data.comment}</div>` : ''}
      `;

      history.insertBefore(item, history.firstChild);

      // æœ€æ–°5ä»¶ã®ã¿è¡¨ç¤º
      while (history.children.length > 5) {
        history.removeChild(history.lastChild);
      }
    }

    // ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³
    function login() {
      const password = document.getElementById('adminPassword').value;

      if (!password) {
        showMessage('loginMessage', 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
        return;
      }

      showLoading('loginMessage');

      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            authToken = result.token;
            showMessage('loginMessage', 'âœ… ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸ', 'success');
            setTimeout(() => {
              showAdminView();
              document.getElementById('loginMessage').innerHTML = '';
            }, 1000);
          } else {
            showMessage('loginMessage', 'âŒ ' + result.error, 'error');
          }
        })
        .withFailureHandler(function(error) {
          showMessage('loginMessage', 'âŒ ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
        })
        .adminLogin(password);
    }

    // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
    function logout() {
      authToken = '';
      document.getElementById('adminPassword').value = '';
      showParticipantView();
    }

    // åˆ©ç”¨å¯èƒ½ãªã‚»ãƒƒã‚·ãƒ§ãƒ³IDã‚’å–å¾—
    function loadAvailableSessionIds() {
      if (!authToken) {
        showMessage('adminMessage', 'èªè¨¼ãŒå¿…è¦ã§ã™', 'error');
        return;
      }

      const hint = document.getElementById('sessionIdsHint');
      hint.innerHTML = '<div class="loading"><div class="spinner"></div>èª­ã¿è¾¼ã¿ä¸­...</div>';

      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            if (result.sessionIds.length === 0) {
              hint.innerHTML = `<div style="color: #ff6b6b;">ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯ã‚ã‚Šã¾ã›ã‚“ï¼ˆç·ãƒ‡ãƒ¼ã‚¿æ•°: ${result.totalRows || 0}è¡Œï¼‰</div>`;
            } else {
              const sessionList = result.sessionIds.map(id => `<strong>${id}</strong>`).join(', ');
              hint.innerHTML = `<div style="color: #667eea;">åˆ©ç”¨å¯èƒ½ãªã‚»ãƒƒã‚·ãƒ§ãƒ³ (${result.sessionIds.length}å€‹): ${sessionList}<br>ç·ãƒ‡ãƒ¼ã‚¿æ•°: ${result.totalRows}è¡Œ</div>`;
            }
          } else {
            hint.innerHTML = `<div style="color: #ff6b6b;">ã‚¨ãƒ©ãƒ¼: ${result.error}</div>`;
          }
        })
        .withFailureHandler(function(error) {
          hint.innerHTML = `<div style="color: #ff6b6b;">ã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
        })
        .getAllSessionIds(authToken);
    }

    // OpenAI APIæ¥ç¶šãƒ†ã‚¹ãƒˆ
    function testAPIConnection() {
      if (!authToken) {
        showMessage('adminMessage', 'èªè¨¼ãŒå¿…è¦ã§ã™', 'error');
        return;
      }

      showLoading('adminMessage');

      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            showMessage('adminMessage',
              `âœ… ${result.message}<br>ãƒ¢ãƒ‡ãƒ«: ${result.model}<br>ãƒ¬ã‚¹ãƒãƒ³ã‚¹: "${result.response}"`,
              'success');
          } else {
            showMessage('adminMessage', `âŒ ${result.error}`, 'error');
          }
        })
        .withFailureHandler(function(error) {
          showMessage('adminMessage', `âŒ æ¥ç¶šãƒ†ã‚¹ãƒˆå¤±æ•—: ${error.message}`, 'error');
        })
        .testOpenAIConnection(authToken);
    }

    // ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
    function loadSessionData() {
      const sessionId = document.getElementById('adminSessionId').value.trim();

      if (!sessionId) {
        showMessage('adminMessage', 'ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
        return;
      }

      if (!authToken) {
        showMessage('adminMessage', 'èªè¨¼ãŒå¿…è¦ã§ã™', 'error');
        return;
      }

      showLoading('adminMessage');

      google.script.run
        .withSuccessHandler(function(result) {
          document.getElementById('adminMessage').innerHTML = '';

          if (result.success) {
            currentSessionData = result.data;
            displayStats(result.data);
            displayData(result.data);
            displayQuestions(result.data);

            document.getElementById('statsContainer').style.display = 'block';
            document.getElementById('dataContainer').style.display = 'block';
            document.getElementById('questionsContainer').style.display = 'block';

            showMessage('adminMessage', `âœ… ${result.data.length}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`, 'success');

            // AIåˆ†æã‚’è‡ªå‹•å®Ÿè¡Œ
            analyzeWithAI(sessionId, result.data);
          } else {
            showMessage('adminMessage', 'âŒ ' + result.error, 'error');
            document.getElementById('statsContainer').style.display = 'none';
            document.getElementById('dataContainer').style.display = 'none';
            document.getElementById('questionsContainer').style.display = 'none';
            document.getElementById('aiAnalysisContainer').style.display = 'none';
          }
        })
        .withFailureHandler(function(error) {
          showMessage('adminMessage', 'âŒ ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
          document.getElementById('statsContainer').style.display = 'none';
          document.getElementById('dataContainer').style.display = 'none';
          document.getElementById('questionsContainer').style.display = 'none';
          document.getElementById('aiAnalysisContainer').style.display = 'none';
        })
        .getSessionData(sessionId, authToken);
    }

    // AIã§åˆ†æï¼ˆåŒæœŸå‡¦ç† + ã‚­ãƒ£ãƒƒã‚·ãƒ¥ + è‡ªå‹•ãƒªãƒˆãƒ©ã‚¤ï¼‰
    function analyzeWithAI(sessionId, data, retryCount = 0) {
      const aiContainer = document.getElementById('aiAnalysisContainer');
      aiContainer.style.display = 'block';

      const isRetry = retryCount > 0;

      // çµŒéæ™‚é–“ã‚’è¡¨ç¤ºã™ã‚‹ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°
      let elapsedSeconds = 0;
      aiContainer.innerHTML = `
        <div class="loading" style="background: #f5f7ff; padding: 30px; border-radius: 10px; text-align: center;">
          <div class="spinner"></div>
          <div style="margin-top: 15px; font-size: 18px; font-weight: 600; color: #667eea;">
            ğŸ¤– ${isRetry ? 'ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰åˆ†æçµæœã‚’èª­ã¿è¾¼ã¿ä¸­...' : 'AIãŒæ™‚ç³»åˆ—ãƒ‡ãƒ¼ã‚¿ã‚’è©³ç´°åˆ†æä¸­...'}
          </div>
          <div id="elapsedTime" style="margin-top: 10px; font-size: 14px; color: #999;">
            çµŒéæ™‚é–“: <span id="elapsedSeconds">0</span>ç§’
          </div>
          ${!isRetry ? `
          <div style="margin-top: 10px; font-size: 13px; color: #999;">
            GPT-4oã«ã‚ˆã‚‹é«˜åº¦ãªåˆ†æã‚’å®Ÿè¡Œã—ã¦ã„ã¾ã™
          </div>
          ` : ''}
          <div style="margin-top: 15px; font-size: 12px; color: #999;">
            ğŸ’¾ ${isRetry ? '(ãƒªãƒˆãƒ©ã‚¤ ' + retryCount + '/3)' : 'åˆ†æçµæœã¯ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚Œã¾ã™'}
          </div>
        </div>
      `;

      // çµŒéæ™‚é–“ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼
      const timer = setInterval(() => {
        elapsedSeconds++;
        const secondsEl = document.getElementById('elapsedSeconds');
        if (secondsEl) {
          secondsEl.textContent = elapsedSeconds;
        }
      }, 1000);

      // åˆ†æã‚’å®Ÿè¡Œï¼ˆåŒæœŸå‡¦ç†ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚ã‚Œã°å³åº§ã«è¿”ã‚‹ï¼‰
      google.script.run
        .withSuccessHandler(function(result) {
          clearInterval(timer);
          if (result.success && result.status === 'completed') {
            // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆã®å ´åˆã¯é€šçŸ¥
            if (result.cached || isRetry) {
              const successMsg = document.createElement('div');
              successMsg.style.cssText = 'background: #d1fae5; color: #065f46; padding: 10px; border-radius: 6px; margin-bottom: 15px; text-align: center; font-size: 13px;';
              successMsg.textContent = isRetry ? 'âœ… ãƒªãƒˆãƒ©ã‚¤æˆåŠŸï¼ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰èª­ã¿è¾¼ã¿ã¾ã—ãŸ' : 'âš¡ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼ˆé«˜é€Ÿï¼‰';
              aiContainer.insertBefore(successMsg, aiContainer.firstChild);
              setTimeout(() => successMsg.remove(), 3000);
            }
            displayAIAnalysis(result);
          } else {
            aiContainer.innerHTML = `
              <div class="message error" style="background: #fff5f5; padding: 20px; border-radius: 10px; border-left: 4px solid #ff6b6b;">
                âŒ AIåˆ†æã‚¨ãƒ©ãƒ¼: ${result.error}
                <div style="margin-top: 10px; font-size: 13px;">
                  çµŒéæ™‚é–“: ${elapsedSeconds}ç§’
                </div>
              </div>
            `;
          }
        })
        .withFailureHandler(function(error) {
          clearInterval(timer);

          // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼ã§ã€ãƒªãƒˆãƒ©ã‚¤å›æ•°ãŒ3å›æœªæº€ãªã‚‰è‡ªå‹•ãƒªãƒˆãƒ©ã‚¤
          if (retryCount < 3 && (error.message.includes('timeout') || error.message.includes('ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ') || elapsedSeconds >= 25)) {
            console.log(`ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæ¤œå‡ºã€ãƒªãƒˆãƒ©ã‚¤ã—ã¾ã™ (${retryCount + 1}/3)`);

            aiContainer.innerHTML = `
              <div style="background: #fff8dc; padding: 20px; border-radius: 10px; border-left: 4px solid #f59e0b; text-align: center;">
                âš ï¸ åˆ†æã«æ™‚é–“ãŒã‹ã‹ã£ã¦ã„ã¾ã™...<br>
                <div style="margin-top: 10px; font-size: 14px;">
                  ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰èª­ã¿è¾¼ã¿ã‚’è©¦è¡Œä¸­ (${retryCount + 1}/3)
                </div>
                <div style="margin-top: 10px; font-size: 12px; color: #666;">
                  åˆå›åˆ†æã¯å®Œäº†ã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚å°‘ã€…ãŠå¾…ã¡ãã ã•ã„...
                </div>
              </div>
            `;

            // 2ç§’å¾…ã£ã¦ã‹ã‚‰ãƒªãƒˆãƒ©ã‚¤
            setTimeout(() => {
              analyzeWithAI(sessionId, data, retryCount + 1);
            }, 2000);
          } else {
            // ãƒªãƒˆãƒ©ã‚¤ä¸Šé™ã«é”ã—ãŸã€ã¾ãŸã¯ãã®ä»–ã®ã‚¨ãƒ©ãƒ¼
            aiContainer.innerHTML = `
              <div class="message error" style="background: #fff5f5; padding: 20px; border-radius: 10px; border-left: 4px solid #ff6b6b;">
                âŒ åˆ†æå¤±æ•—: ${error.message}
                <div style="margin-top: 10px; font-size: 13px;">
                  çµŒéæ™‚é–“: ${elapsedSeconds}ç§’
                </div>
                <div style="margin-top: 15px; font-size: 12px;">
                  ğŸ’¡ åˆå›åˆ†æã«ã¯æœ€å¤§1åˆ†ç¨‹åº¦ã‹ã‹ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚<br>
                  ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ã€Œãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€ã€ã‚’å†å®Ÿè¡Œã™ã‚‹ã¨ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰é«˜é€Ÿã«èª­ã¿è¾¼ã¾ã‚Œã¾ã™ã€‚
                </div>
                <button onclick="loadSessionData()" style="margin-top: 15px; padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer;">
                  ğŸ”„ å†èª­ã¿è¾¼ã¿
                </button>
              </div>
            `;
          }
        })
        .startAnalysis(sessionId, authToken);
    }

    // AIåˆ†æçµæœã‚’è¡¨ç¤º
    function displayAIAnalysis(result) {
      const container = document.getElementById('aiAnalysisContainer');
      container.style.display = 'block';

      // HTMLæ§‹é€ ã‚’å¾©å…ƒï¼ˆãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ã§æ¶ˆãˆãŸãŸã‚ï¼‰
      container.innerHTML = `
        <h2>ğŸ¤– AIåˆ†æçµæœ</h2>
        <div id="aiAnalysisContent" style="background: #f5f7ff; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
          <div id="overallMood" style="margin-bottom: 20px;">
            <h3 style="color: #667eea; margin-bottom: 10px;">ğŸ“Š å…¨ä½“ã®é›°å›²æ°—</h3>
            <p id="overallMoodText" style="font-size: 16px; line-height: 1.6;"></p>
          </div>

          <div id="timeProgression" style="margin-bottom: 20px;">
            <h3 style="color: #667eea; margin-bottom: 10px;">â° æ™‚é–“çµŒéã«ä¼´ã†å¤‰åŒ–</h3>
            <p id="timeProgressionText" style="font-size: 16px; line-height: 1.6; background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #667eea;"></p>
          </div>

          <div id="keyInsights" style="margin-bottom: 20px;">
            <h3 style="color: #667eea; margin-bottom: 10px;">ğŸ’¡ ä¸»ãªã‚¤ãƒ³ã‚µã‚¤ãƒˆ</h3>
            <ul id="keyInsightsList" style="list-style: none; padding: 0;"></ul>
          </div>

          <div id="positiveHighlights" style="margin-bottom: 20px;">
            <h3 style="color: #667eea; margin-bottom: 10px;">âœ… ãƒã‚¸ãƒ†ã‚£ãƒ–ãªç‚¹</h3>
            <ul id="positiveHighlightsList" style="list-style: none; padding: 0;"></ul>
          </div>

          <div id="concerns" style="margin-bottom: 20px;">
            <h3 style="color: #667eea; margin-bottom: 10px;">âš ï¸ æ‡¸å¿µäº‹é …</h3>
            <ul id="concernsList" style="list-style: none; padding: 0;"></ul>
          </div>

          <div id="speakerAdvice" style="margin-bottom: 20px;">
            <h3 style="color: #667eea; margin-bottom: 10px;">ğŸ¤ ç™»å£‡è€…ã¸ã®å…·ä½“çš„ã‚¢ãƒ‰ãƒã‚¤ã‚¹</h3>
            <ul id="speakerAdviceList" style="list-style: none; padding: 0;"></ul>
          </div>

          <div id="recommendations">
            <h3 style="color: #667eea; margin-bottom: 10px;">ğŸ¯ æ¬¡å›ã«å‘ã‘ãŸæ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</h3>
            <ul id="recommendationsList" style="list-style: none; padding: 0;"></ul>
          </div>
        </div>

        <div id="emotionDistributionContainer" style="background: #f5f7ff; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
          <h3 style="color: #667eea; margin-bottom: 15px;">ğŸ“Š æ™‚é–“å¸¯åˆ¥ã®æ„Ÿæƒ…åˆ†å¸ƒ</h3>
          <div style="display: flex; justify-content: space-around; flex-wrap: wrap; gap: 20px;">
            <div style="text-align: center; flex: 1; min-width: 200px;">
              <h4 style="color: #555; margin-bottom: 10px;">åºç›¤</h4>
              <canvas id="pieChart1" width="200" height="200"></canvas>
              <div id="pieStats1" style="margin-top: 10px; font-size: 12px; color: #666;"></div>
            </div>
            <div style="text-align: center; flex: 1; min-width: 200px;">
              <h4 style="color: #555; margin-bottom: 10px;">ä¸­ç›¤</h4>
              <canvas id="pieChart2" width="200" height="200"></canvas>
              <div id="pieStats2" style="margin-top: 10px; font-size: 12px; color: #666;"></div>
            </div>
            <div style="text-align: center; flex: 1; min-width: 200px;">
              <h4 style="color: #555; margin-bottom: 10px;">çµ‚ç›¤</h4>
              <canvas id="pieChart3" width="200" height="200"></canvas>
              <div id="pieStats3" style="margin-top: 10px; font-size: 12px; color: #666;"></div>
            </div>
          </div>
        </div>

        <div id="participantInsights" style="background: #f5f7ff; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
          <h3 style="color: #667eea; margin-bottom: 10px;">ğŸ‘¥ å‚åŠ è€…åˆ¥ãƒˆãƒ¬ãƒ³ãƒ‰</h3>
          <div id="participantTrendsList"></div>
        </div>

        <div id="timelineInsights" style="background: #f5f7ff; padding: 20px; border-radius: 10px;">
          <h3 style="color: #667eea; margin-bottom: 10px;">â±ï¸ æ™‚é–“å¸¯åˆ¥ã®æ„Ÿæƒ…æ¨ç§»</h3>
          <div id="timelineChart"></div>
        </div>
      `;

      // å…¨ä½“ã®é›°å›²æ°—
      document.getElementById('overallMoodText').textContent = result.analysis.overallMood;

      // æ™‚é–“çµŒéã«ä¼´ã†å¤‰åŒ–
      document.getElementById('timeProgressionText').textContent = result.analysis.timeProgression || 'æ™‚ç³»åˆ—ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æä¸­...';

      // ä¸»ãªã‚¤ãƒ³ã‚µã‚¤ãƒˆ
      const insightsList = document.getElementById('keyInsightsList');
      insightsList.innerHTML = '';
      result.analysis.keyInsights.forEach(insight => {
        const li = document.createElement('li');
        li.style.padding = '8px 0';
        li.style.borderBottom = '1px solid #e0e0e0';
        li.innerHTML = `<span style="color: #667eea;">â€¢</span> ${insight}`;
        insightsList.appendChild(li);
      });

      // ãƒã‚¸ãƒ†ã‚£ãƒ–ãªç‚¹
      const positiveList = document.getElementById('positiveHighlightsList');
      positiveList.innerHTML = '';
      result.analysis.positiveHighlights.forEach(highlight => {
        const li = document.createElement('li');
        li.style.padding = '8px 0';
        li.style.borderBottom = '1px solid #e0e0e0';
        li.innerHTML = `<span style="color: #6bcf7f;">âœ“</span> ${highlight}`;
        positiveList.appendChild(li);
      });

      // æ‡¸å¿µäº‹é …
      const concernsList = document.getElementById('concernsList');
      concernsList.innerHTML = '';
      if (result.analysis.concerns && result.analysis.concerns.length > 0) {
        result.analysis.concerns.forEach(concern => {
          const li = document.createElement('li');
          li.style.padding = '8px 0';
          li.style.borderBottom = '1px solid #e0e0e0';
          li.innerHTML = `<span style="color: #ff6b6b;">âš </span> ${concern}`;
          concernsList.appendChild(li);
        });
      } else {
        concernsList.innerHTML = '<li style="color: #999;">ç‰¹ã«æ‡¸å¿µäº‹é …ã¯ã‚ã‚Šã¾ã›ã‚“</li>';
      }

      // ç™»å£‡è€…ã¸ã®å…·ä½“çš„ã‚¢ãƒ‰ãƒã‚¤ã‚¹
      const speakerAdviceList = document.getElementById('speakerAdviceList');
      speakerAdviceList.innerHTML = '';
      if (result.analysis.speakerAdvice && result.analysis.speakerAdvice.length > 0) {
        result.analysis.speakerAdvice.forEach(advice => {
          const li = document.createElement('li');
          li.style.padding = '10px';
          li.style.marginBottom = '8px';
          li.style.background = 'white';
          li.style.borderRadius = '6px';
          li.style.borderLeft = '3px solid #f59e0b';
          li.innerHTML = `<span style="color: #f59e0b; margin-right: 8px;">ğŸ’¡</span> ${advice}`;
          speakerAdviceList.appendChild(li);
        });
      } else {
        speakerAdviceList.innerHTML = '<li style="color: #999;">ç™»å£‡è€…ã¸ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ç”Ÿæˆä¸­...</li>';
      }

      // æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
      const recommendationsList = document.getElementById('recommendationsList');
      recommendationsList.innerHTML = '';
      result.analysis.recommendations.forEach(recommendation => {
        const li = document.createElement('li');
        li.style.padding = '8px 0';
        li.style.borderBottom = '1px solid #e0e0e0';
        li.innerHTML = `<span style="color: #667eea;">â†’</span> ${recommendation}`;
        recommendationsList.appendChild(li);
      });

      // å‚åŠ è€…åˆ¥ãƒˆãƒ¬ãƒ³ãƒ‰
      const participantTrends = document.getElementById('participantTrendsList');
      participantTrends.innerHTML = '';
      result.participants.slice(0, 10).forEach(p => {
        const trendEmoji = p.trend === 'rising' ? 'ğŸ“ˆ' : p.trend === 'falling' ? 'ğŸ“‰' : 'â¡ï¸';
        const trendColor = p.trend === 'rising' ? '#6bcf7f' : p.trend === 'falling' ? '#ff6b6b' : '#999';
        const trendText = p.trend === 'rising' ? 'ä¸Šæ˜‡å‚¾å‘' : p.trend === 'falling' ? 'ä¸‹é™å‚¾å‘' : 'å®‰å®š';

        const div = document.createElement('div');
        div.style.padding = '12px';
        div.style.marginBottom = '10px';
        div.style.background = 'white';
        div.style.borderRadius = '8px';
        div.style.borderLeft = `4px solid ${trendColor}`;
        div.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <strong>${p.nickname}</strong>
              <span style="color: #999; font-size: 14px; margin-left: 10px;">${p.count}ä»¶ã®ç™ºè¨€</span>
            </div>
            <div style="text-align: right;">
              <div style="font-size: 20px; font-weight: 700; color: ${trendColor};">${p.averageScore.toFixed(1)}</div>
              <div style="font-size: 12px; color: ${trendColor};">${trendEmoji} ${trendText}</div>
            </div>
          </div>
        `;
        participantTrends.appendChild(div);
      });

      // æ„Ÿæƒ…åˆ†å¸ƒã®å††ã‚°ãƒ©ãƒ•ã‚’æç”»
      if (result.emotionDistribution && result.emotionDistribution.length === 3) {
        drawPieChart('pieChart1', 'pieStats1', result.emotionDistribution[0]);
        drawPieChart('pieChart2', 'pieStats2', result.emotionDistribution[1]);
        drawPieChart('pieChart3', 'pieStats3', result.emotionDistribution[2]);
      }

      // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³
      const timelineChart = document.getElementById('timelineChart');
      timelineChart.innerHTML = '';
      if (result.timeline.length > 0) {
        result.timeline.forEach(interval => {
          const time = new Date(interval.startTime).toLocaleTimeString('ja-JP', {
            hour: '2-digit',
            minute: '2-digit'
          });
          const score = interval.avgScore;
          const color = score > 0 ? '#6bcf7f' : score < 0 ? '#ff6b6b' : '#999';
          const width = Math.abs(score) * 10 + '%';

          const div = document.createElement('div');
          div.style.marginBottom = '10px';
          div.innerHTML = `
            <div style="display: flex; align-items: center; margin-bottom: 5px;">
              <span style="min-width: 60px; font-size: 12px; color: #666;">${time}</span>
              <div style="flex: 1; background: #e0e0e0; height: 24px; border-radius: 4px; position: relative; overflow: hidden;">
                <div style="position: absolute; left: 50%; width: 1px; height: 100%; background: #999;"></div>
                <div style="position: absolute; ${score > 0 ? 'left: 50%' : 'right: 50%'}; width: ${width}; height: 100%; background: ${color}; transition: width 0.3s;"></div>
              </div>
              <span style="min-width: 60px; text-align: right; font-weight: 600; color: ${color};">${score.toFixed(2)}</span>
            </div>
            <div style="font-size: 11px; color: #999; margin-left: 60px;">${interval.count}ä»¶ã®ç™ºè¨€</div>
          `;
          timelineChart.appendChild(div);
        });
      } else {
        timelineChart.innerHTML = '<p style="color: #999;">ãƒ‡ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã¾ã™</p>';
      }
    }

    // å††ã‚°ãƒ©ãƒ•ã‚’æç”»
    function drawPieChart(canvasId, statsId, data) {
      const canvas = document.getElementById(canvasId);
      const statsDiv = document.getElementById(statsId);

      if (!canvas || !data) return;

      const ctx = canvas.getContext('2d');

      // ã‚¹ãƒãƒ›å¯¾å¿œ: ç”»é¢ã‚µã‚¤ã‚ºã«å¿œã˜ã¦å††ã‚°ãƒ©ãƒ•ã®ã‚µã‚¤ã‚ºã‚’èª¿æ•´
      const isMobile = window.innerWidth <= 600;
      const size = isMobile ? 180 : 200;
      canvas.width = size;
      canvas.height = size;

      const centerX = canvas.width / 2;
      const centerY = canvas.height / 2;
      const radius = isMobile ? 72 : 80;

      // ãƒ‡ãƒ¼ã‚¿ã®æº–å‚™
      const total = data.total;
      const positive = data.positive;
      const neutral = data.neutral;
      const negative = data.negative;

      // å‰²åˆã‚’è¨ˆç®—
      const positiveAngle = (positive / total) * 2 * Math.PI;
      const neutralAngle = (neutral / total) * 2 * Math.PI;
      const negativeAngle = (negative / total) * 2 * Math.PI;

      // è‰²ã®å®šç¾©
      const positiveColor = '#6bcf7f';
      const neutralColor = '#ffd93d';
      const negativeColor = '#ff6b6b';

      // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ã‚¯ãƒªã‚¢
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // å††ã‚°ãƒ©ãƒ•ã‚’æç”»
      let currentAngle = -Math.PI / 2; // 12æ™‚ã®ä½ç½®ã‹ã‚‰é–‹å§‹

      // ãƒã‚¸ãƒ†ã‚£ãƒ–
      if (positive > 0) {
        ctx.beginPath();
        ctx.moveTo(centerX, centerY);
        ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + positiveAngle);
        ctx.closePath();
        ctx.fillStyle = positiveColor;
        ctx.fill();
        currentAngle += positiveAngle;
      }

      // ãƒ‹ãƒ¥ãƒ¼ãƒˆãƒ©ãƒ«
      if (neutral > 0) {
        ctx.beginPath();
        ctx.moveTo(centerX, centerY);
        ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + neutralAngle);
        ctx.closePath();
        ctx.fillStyle = neutralColor;
        ctx.fill();
        currentAngle += neutralAngle;
      }

      // ãƒã‚¬ãƒ†ã‚£ãƒ–
      if (negative > 0) {
        ctx.beginPath();
        ctx.moveTo(centerX, centerY);
        ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + negativeAngle);
        ctx.closePath();
        ctx.fillStyle = negativeColor;
        ctx.fill();
      }

      // çµ±è¨ˆæƒ…å ±ã‚’è¡¨ç¤º
      statsDiv.innerHTML = `
        <div style="display: flex; flex-direction: column; gap: 5px;">
          <div style="display: flex; align-items: center; justify-content: center; gap: 8px;">
            <div style="width: 12px; height: 12px; background: ${positiveColor}; border-radius: 2px;"></div>
            <span>ãƒã‚¸ãƒ†ã‚£ãƒ–: ${data.positiveRate.toFixed(1)}%</span>
          </div>
          <div style="display: flex; align-items: center; justify-content: center; gap: 8px;">
            <div style="width: 12px; height: 12px; background: ${neutralColor}; border-radius: 2px;"></div>
            <span>ãƒ‹ãƒ¥ãƒ¼ãƒˆãƒ©ãƒ«: ${data.neutralRate.toFixed(1)}%</span>
          </div>
          <div style="display: flex; align-items: center; justify-content: center; gap: 8px;">
            <div style="width: 12px; height: 12px; background: ${negativeColor}; border-radius: 2px;"></div>
            <span>ãƒã‚¬ãƒ†ã‚£ãƒ–: ${data.negativeRate.toFixed(1)}%</span>
          </div>
          <div style="margin-top: 5px; font-weight: 600; color: #333;">
            åˆè¨ˆ: ${total}ä»¶
          </div>
        </div>
      `;
    }

    // çµ±è¨ˆæƒ…å ±ã‚’è¡¨ç¤º
    function displayStats(data) {
      const scores = data.map(d => d.moodScore);
      const total = scores.length;
      const sum = scores.reduce((a, b) => a + b, 0);
      const avg = sum / total;
      const positive = scores.filter(s => s > 0).length;
      const participants = new Set(data.map(d => d.nickname)).size;

      const statsHtml = `
        <div class="stat-card">
          <div class="stat-value">${total}</div>
          <div class="stat-label">ç·ç™ºè¨€æ•°</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${participants}</div>
          <div class="stat-label">å‚åŠ è€…æ•°</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${avg.toFixed(2)}</div>
          <div class="stat-label">å¹³å‡ã‚¹ã‚³ã‚¢</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${((positive/total)*100).toFixed(1)}%</div>
          <div class="stat-label">ãƒã‚¸ãƒ†ã‚£ãƒ–ç‡</div>
        </div>
      `;

      document.getElementById('stats').innerHTML = statsHtml;
    }

    // ãƒ‡ãƒ¼ã‚¿ä¸€è¦§ã‚’è¡¨ç¤º
    function displayData(data) {
      const tbody = document.getElementById('dataBody');
      tbody.innerHTML = '';

      data.forEach(d => {
        const row = tbody.insertRow();
        const time = new Date(d.timestamp).toLocaleTimeString('ja-JP');

        row.innerHTML = `
          <td>${time}</td>
          <td>${d.nickname}</td>
          <td>${d.moodScore}</td>
          <td>${d.emoticon}</td>
          <td>${d.comment}</td>
        `;
      });
    }

    // è³ªå•ã‚’è¡¨ç¤º
    function displayQuestions(data) {
      const questionsList = document.getElementById('questionsList');
      const noQuestionsMessage = document.getElementById('noQuestionsMessage');
      
      // è³ªå•ã®ã¿ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
      const questions = data.filter(d => d.question && d.question.trim());

      questionsList.innerHTML = '';

      if (questions.length === 0) {
        noQuestionsMessage.style.display = 'block';
      } else {
        noQuestionsMessage.style.display = 'none';
        questions.forEach((q, index) => {
          const time = new Date(q.timestamp).toLocaleTimeString('ja-JP');
          const div = document.createElement('div');
          div.style.cssText = 'background: white; padding: 16px; margin-bottom: 12px; border-radius: 8px; border-left: 4px solid #667eea;';
          div.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
              <div>
                <strong style="font-size: 18px; color: #333;">${q.nickname}</strong>
                <span style="color: #999; font-size: 14px; margin-left: 10px;">è³ªå• #${index + 1}</span>
              </div>
              <span style="color: #999; font-size: 14px;">${time}</span>
            </div>
            <p style="font-size: 16px; line-height: 1.6; color: #555; margin: 10px 0;">
              <strong>â“ ${q.question}</strong>
            </p>
            ${q.comment ? `<p style="font-size: 14px; color: #999; margin-top: 8px; padding-top: 8px; border-top: 1px solid #e0e0e0;">è£œè¶³: ${q.comment}</p>` : ''}
          `;
          questionsList.appendChild(div);
        });
      }
    }

    // è³ªå•ã‚’CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
    function downloadQuestions() {
      if (currentSessionData.length === 0) {
        showMessage('adminMessage', 'ãƒ‡ãƒ¼ã‚¿ã‚’å…ˆã«èª­ã¿è¾¼ã‚“ã§ãã ã•ã„', 'error');
        return;
      }

      const questions = currentSessionData.filter(d => d.question && d.question.trim());

      if (questions.length === 0) {
        showMessage('adminMessage', 'ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹è³ªå•ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
        return;
      }

      const sessionId = document.getElementById('adminSessionId').value.trim();
      let csv = 'ã‚»ãƒƒã‚·ãƒ§ãƒ³ID,æ™‚åˆ»,ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ,è³ªå•,è£œè¶³ã‚³ãƒ¡ãƒ³ãƒˆ\n';

      questions.forEach(q => {
        const time = new Date(q.timestamp).toLocaleTimeString('ja-JP');
        const question = `"${q.question.replace(/"/g, '""')}"`;
        const comment = `"${(q.comment || '').replace(/"/g, '""')}"`;
        csv += `${sessionId},${time},${q.nickname},${question},${comment}\n`;
      });

      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', `questions_${sessionId}_${new Date().getTime()}.csv`);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);

      showMessage('adminMessage', `âœ… ${questions.length}ä»¶ã®è³ªå•ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ`, 'success');
    }

    // ã‚¹ãƒ©ã‚¤ãƒ‰ç”Ÿæˆ
    function generateSlides() {
      if (currentSessionData.length === 0) {
        showMessage('adminMessage', 'ãƒ‡ãƒ¼ã‚¿ã‚’å…ˆã«èª­ã¿è¾¼ã‚“ã§ãã ã•ã„', 'error');
        return;
      }

      const sessionId = document.getElementById('adminSessionId').value.trim();

      showLoading('adminMessage');
      document.getElementById('generateBtn').disabled = true;

      google.script.run
        .withSuccessHandler(function(result) {
          document.getElementById('generateBtn').disabled = false;

          if (result.success) {
            showMessage('adminMessage',
              `âœ… ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’ç”Ÿæˆã—ã¾ã—ãŸï¼<br><a href="${result.slideUrl}" target="_blank" style="color: #667eea;">ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’é–‹ã</a>`,
              'success');
          } else {
            showMessage('adminMessage', 'âŒ ' + result.error, 'error');
          }
        })
        .withFailureHandler(function(error) {
          document.getElementById('generateBtn').disabled = false;
          showMessage('adminMessage', 'âŒ ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
        })
        .generateSlides(sessionId, currentSessionData, authToken);
    }
  </script>
</body>
</html>
