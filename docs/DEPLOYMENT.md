# MoodFlow デプロイメントガイド

このガイドでは、MoodFlowを本番環境にデプロイする詳細な手順を説明します。

## デプロイの種類

MoodFlowは以下のデプロイ方法をサポートしています：

1. **テストデプロイ** - 開発・テスト用
2. **本番デプロイ** - 実際の会議で使用

## 前提条件

- [SETUP.md](SETUP.md) の手順を完了していること
- Gemini APIキーが設定されていること
- スプレッドシートが初期化されていること

## テストデプロイ

開発中やテスト時に使用します。

### 手順

1. Apps Script エディタで **デプロイ** → **デプロイをテスト** をクリック
2. デプロイタイプで **ウェブアプリ** を選択
3. テスト用URLが表示されるので、それを使ってテスト

### 特徴

- コード変更が即座に反映される
- 本番環境に影響しない
- URL は毎回変わる可能性がある

## 本番デプロイ

### 初回デプロイ

1. Apps Script エディタで **デプロイ** → **新しいデプロイ** をクリック

2. **種類の選択** で歯車アイコンをクリックし、**ウェブアプリ** を選択

3. 以下の設定を行う：

   **新しい説明文**
   ```
   MoodFlow v1.0 - 初回リリース
   ```

   **次のユーザーとして実行**
   - **自分** を選択
   - これにより、アプリはあなたの権限で実行されます

   **アクセスできるユーザー**
   - **全員** を選択
   - 参加者がGoogleアカウントなしでアクセスできるようにします

4. **デプロイ** をクリック

5. 承認画面が表示されたら：
   - **アクセスを承認** をクリック
   - Googleアカウントを選択
   - **詳細** → **（プロジェクト名）に移動** をクリック
   - **許可** をクリック

6. **デプロイID** と **ウェブアプリURL** が表示されます
   - これらを安全な場所に保存してください
   - 特にデプロイIDは更新時に必要です

### URLの確認

デプロイ完了後、以下のURLが利用可能になります：

- **管理者ダッシュボード**: `https://script.google.com/macros/s/{DEPLOY_ID}/exec?page=admin`
- **参加者アプリ**: セッション作成時に自動生成

## デプロイの更新

コードを変更した後、本番環境を更新する手順です。

### 手順

1. コードを変更・テストする

2. Apps Script エディタで **デプロイ** → **デプロイを管理** をクリック

3. 現在のデプロイの右側にある鉛筆アイコン（編集）をクリック

4. **バージョン** で **新バージョン** を選択

5. **説明** を更新（変更内容を記載）
   ```
   例: v1.1 - バグ修正とUI改善
   ```

6. **デプロイ** をクリック

### 注意点

- デプロイIDとURLは変わりません
- 既存の参加者用URLも引き続き使用可能
- 変更が反映されるまで数秒〜数分かかる場合があります

## バージョン管理

### 推奨バージョニング

セマンティックバージョニングを使用：`MAJOR.MINOR.PATCH`

- **MAJOR**: 互換性のない大きな変更
- **MINOR**: 後方互換性のある機能追加
- **PATCH**: 後方互換性のあるバグ修正

### 例

```
v1.0.0 - 初回リリース
v1.0.1 - ログ機能のバグ修正
v1.1.0 - 新しいグラフ機能を追加
v2.0.0 - データ構造の大幅変更
```

## セキュリティ設定

### スクリプトプロパティの保護

1. Apps Script エディタで **プロジェクト設定**（⚙️）をクリック
2. **スクリプト プロパティ** で `GEMINI_API_KEY` が設定されているか確認
3. APIキーは絶対にコードに書かないこと

### アクセス制御

**管理者ダッシュボード**
- URLを会議主催者のみに共有
- 必要に応じてGoogleアカウント認証を追加可能

**参加者アプリ**
- セッションIDベースで分離
- 他のセッションのデータにはアクセス不可

### データ保護

1. **スプレッドシートの共有設定**
   ```
   推奨: 自分のみがアクセス可能
   ```

2. **定期的なバックアップ**
   - 重要な会議の前後にスプレッドシートをコピー

3. **データの削除**
   - 会議終了後、不要なデータは定期的に削除

## パフォーマンス最適化

### 同時接続数の管理

- **推奨**: 10〜30人
- **最大**: 50人（テスト済み）
- それ以上の場合は複数セッションに分割

### スプレッドシートの最適化

1. **定期的なクリーンアップ**
   ```javascript
   // 古いデータを別シートに移動または削除
   function archiveOldSessions() {
     // 実装例
   }
   ```

2. **インデックスの活用**
   - セッションIDでフィルタリング
   - 時系列順にソート

### キャッシュの活用

現在の実装では以下をキャッシュ：
- セッション情報（5分）
- 参加者情報（5分）

## モニタリング

### ログの確認

1. Apps Script エディタで **実行数** をクリック
2. エラーや実行時間を確認

### エラー通知の設定

1. Apps Script エディタで **トリガー**（時計アイコン）をクリック
2. **通知設定** でエラー時のメール通知を設定

## ロールバック手順

問題が発生した場合、以前のバージョンに戻す手順：

1. **デプロイを管理** をクリック
2. 問題のあるデプロイの **アーカイブ** をクリック
3. 前のバージョンを **新しいデプロイ** として再デプロイ

または

1. Gitから前のバージョンのコードを取得
2. Apps Scriptにコピー＆ペースト
3. 新しいバージョンとしてデプロイ

## 本番環境チェックリスト

デプロイ前に確認：

- [ ] すべてのテストが成功している
- [ ] Gemini APIキーが設定されている
- [ ] スプレッドシートが初期化されている
- [ ] エラーハンドリングが適切に実装されている
- [ ] ログが適切に出力されている
- [ ] セキュリティ設定が適切である
- [ ] バックアップが取得されている
- [ ] バージョン番号が更新されている
- [ ] 変更内容がドキュメント化されている

デプロイ後に確認：

- [ ] 管理者ダッシュボードが正常に表示される
- [ ] セッションが作成できる
- [ ] 参加者が参加できる
- [ ] ムードデータが送信・保存される
- [ ] リアルタイム分析が表示される
- [ ] レポートが生成される
- [ ] 複数参加者での同時アクセスが正常に動作する

## トラブルシューティング

### デプロイが失敗する

**原因**: 権限不足
**解決法**:
1. Google Drive APIを有効化
2. 再度承認を実行

### URLにアクセスできない

**原因**: アクセス設定が誤っている
**解決法**:
1. デプロイ設定で「全員」を選択
2. URLが `/exec` で終わっているか確認

### データが保存されない

**原因**: スプレッドシートへの書き込み権限がない
**解決法**:
1. スプレッドシートの所有者を確認
2. Apps Scriptとスプレッドシートが同じアカウントか確認

### APIエラーが頻発する

**原因**: Gemini APIのクォータ超過
**解決法**:
1. API使用量を確認
2. 必要に応じて有料プランに変更
3. API呼び出しを最適化

## 本番運用のベストプラクティス

1. **事前テスト**
   - 本番会議の前に必ずテストセッションで動作確認

2. **バックアップ計画**
   - 重要な会議の前にスプレッドシートをコピー

3. **モニタリング**
   - 会議中は管理者ダッシュボードを開いておく

4. **エラー対応**
   - エラー発生時の連絡先を参加者に共有

5. **データ管理**
   - 会議終了後48時間以内にレポートを生成
   - 定期的に古いデータをアーカイブ

## スケールアップ

より大規模な運用が必要な場合：

### オプション1: 複数デプロイ
- チームごとに別のデプロイを作成
- 各デプロイが独立したスプレッドシートを使用

### オプション2: Cloud Firestore 移行
- スプレッドシートの代わりにFirestoreを使用
- より高いパフォーマンスとスケーラビリティ

### オプション3: 外部ホスティング
- GASから完全なWebアプリケーションに移行
- Node.js + Express + MongoDB など

## サポート

デプロイに関する問題は、GitHubのIssueで報告してください。

## 参照

- [Google Apps Script デプロイメント](https://developers.google.com/apps-script/concepts/deployments)
- [ウェブアプリ](https://developers.google.com/apps-script/guides/web)
- [ベストプラクティス](https://developers.google.com/apps-script/guides/support/best-practices)
